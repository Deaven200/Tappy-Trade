<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tappy Trade</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1a1a2e">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tappy Trade">
    <!-- Base64 Favicon to prevent 404 -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <!-- Initialize Firebase BEFORE modules load -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBu_Ge0jpMTxSz8-n-12VwsjMFj6gCJBwQ",
            authDomain: "tappy-trade.firebaseapp.com",
            projectId: "tappy-trade",
            storageBucket: "tappy-trade.firebasestorage.app",
            messagingSenderId: "408809771678",
            appId: "1:408809771678:web:205415f89cac488604618f"
        };
        firebase.initializeApp(firebaseConfig);
        window.firebase = firebase;
        window.db = firebase.firestore();
        console.log('‚úÖ Firebase initialized early for modules');
    </script>

    <!-- Load modular game code -->
    <script type="module" src="js/main.js"></script>
    <style>
        :root {
            --bg: #0f0f1a;
            --bg1: #0f0f1a;
            --bg2: #1a1a2e;
            --card: #252542;
            --hover: #2d2d4a;
            --gold: #ffd700;
            --green: #4ade80;
            --blue: #60a5fa;
            --purple: #a78bfa;
            --red: #f87171;
            --orange: #fb923c;
            --text: #fff;
            --muted: #6b6b7b;
            --nav: 70px;
            --r: 12px
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%;
            overflow: hidden
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            user-select: none;
            -webkit-tap-highlight-color: transparent
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg2)
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1)
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem
        }

        .stat b {
            color: var(--gold)
        }

        .stat.inv b {
            color: var(--blue)
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            height: var(--nav);
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100
        }

        .nav button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            background: var(--card);
            border: none;
            border-radius: var(--r);
            color: var(--muted);
            cursor: pointer;
            font-family: inherit;
            transition: 0.2s
        }

        .nav button:hover {
            background: var(--hover);
            color: var(--text)
        }

        .nav button.active {
            background: linear-gradient(135deg, var(--purple), #8b5cf6);
            color: #fff
        }

        .nav .num {
            font-size: 1rem;
            font-weight: 700
        }

        .nav .lbl {
            font-size: 0.55rem;
            text-transform: uppercase
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            padding-bottom: calc(var(--nav) + 16px)
        }

        .plot {
            background: var(--card);
            border-radius: var(--r);
            padding: 10px;
            margin-bottom: 10px
        }

        .subs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px
        }

        .sub {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 6px;
            background: var(--bg2);
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.15s;
            min-height: 85px
        }

        .sub:hover {
            background: var(--hover)
        }

        .sub:active {
            transform: scale(0.96)
        }

        .sub.ready {
            border-color: var(--green)
        }

        .sub .icon {
            font-size: 1.8rem
        }

        .sub .cnt {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--green);
            color: var(--bg);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 8px
        }

        .sub .cnt.zero {
            background: var(--muted)
        }

        .sub .bar {
            width: 100%;
            height: 3px;
            background: var(--bg);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden
        }

        .sub .bar div {
            height: 100%;
            background: var(--green);
            transition: width 0.3s
        }

        /* Circular progress indicator */
        .progress-ring {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: conic-gradient(var(--green) var(--progress, 0%), var(--bg) 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px auto 0;
        }

        .progress-ring-inner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .progress-ring.full {
            background: var(--green);
            animation: pulse 1s infinite;
        }

        .sub .lvl {
            position: absolute;
            bottom: 2px;
            left: 2px;
            font-size: 0.55rem;
            color: var(--purple);
            font-weight: 600
        }

        .sub.building {
            border-color: var(--purple)
        }

        .sub.building .cnt {
            background: var(--purple)
        }

        .locked {
            background: rgba(37, 37, 66, 0.5);
            border: 2px dashed var(--muted);
            text-align: center;
            padding: 24px;
            cursor: pointer
        }

        .locked:hover {
            border-color: var(--gold)
        }

        .locked.can {
            animation: glow 2s infinite
        }

        .locked h4 {
            color: var(--gold);
            font-size: 1.2rem;
            margin: 6px 0
        }

        .locked button {
            margin-top: 10px;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--gold), #ff9500);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer
        }

        .locked button:disabled {
            background: var(--hover);
            color: var(--muted);
            cursor: not-allowed
        }

        .screen {
            display: none
        }

        .screen.active {
            display: block
        }

        .panel {
            background: var(--card);
            border-radius: var(--r);
            padding: 16px;
            margin-bottom: 12px
        }

        .panel h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px
        }

        .item .ic {
            font-size: 1.3rem
        }

        .item .nm {
            flex: 1;
            font-size: 0.9rem
        }

        .item .qt {
            font-weight: 700;
            color: var(--blue);
            min-width: 40px;
            text-align: right
        }

        .item .pr {
            font-size: 0.75rem;
            color: var(--green)
        }

        .btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--gold), #ff9500);
            color: var(--bg);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer
        }

        .btn:hover {
            transform: scale(1.03)
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none
        }

        .btn.red {
            background: linear-gradient(135deg, var(--red), #dc2626)
        }

        .btn.green {
            background: linear-gradient(135deg, var(--green), #22c55e)
        }

        .btn.purple {
            background: linear-gradient(135deg, var(--purple), #8b5cf6)
        }

        .empty {
            text-align: center;
            padding: 30px;
            color: var(--muted)
        }

        .toast {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: var(--card);
            padding: 10px 18px;
            border-radius: 8px;
            opacity: 0;
            transition: 0.3s;
            z-index: 1000;
            font-size: 0.85rem;
            border-left: 3px solid var(--blue)
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0)
        }

        .toast.ok {
            border-color: var(--green)
        }

        .toast.err {
            border-color: var(--red)
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto
        }

        .modal-box {
            background: var(--card);
            border-radius: var(--r);
            width: 90%;
            max-width: 380px;
            max-height: 80vh;
            overflow-y: auto
        }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: var(--card)
        }

        .modal-head h3 {
            font-size: 1rem
        }

        .modal-close {
            width: 44px;
            height: 44px;
            background: #ef4444;
            /* Bright red */
            border: 2px solid #dc2626;
            border-radius: 50%;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: 300;
            line-height: 1;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        .modal-close:hover {
            background: #dc2626;
            /* Darker red on hover */
            border-color: #b91c1c;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
        }

        .modal-body {
            padding: 14px
        }

        .cat {
            margin-bottom: 16px
        }

        .cat-title {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px
        }

        .bld {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: 0.2s
        }

        .bld:hover {
            background: var(--hover)
        }

        .bld.off {
            opacity: 0.5;
            cursor: not-allowed
        }

        .bld .ic {
            font-size: 1.6rem
        }

        .bld .info {
            flex: 1
        }

        .bld .nm {
            font-weight: 600;
            font-size: 0.9rem
        }

        .bld .prod {
            font-size: 0.7rem;
            color: var(--green)
        }

        .bld .cost {
            font-size: 0.65rem;
            color: var(--muted)
        }

        .bld .cost .m {
            color: var(--gold)
        }

        .bld .cost .r {
            color: var(--blue)
        }

        .achieve {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px;
            margin-bottom: 6px
        }

        .achieve.done {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--green)
        }

        .achieve .ic {
            font-size: 1.5rem
        }

        .achieve .info {
            flex: 1
        }

        .achieve .nm {
            font-weight: 600;
            font-size: 0.85rem
        }

        .achieve .desc {
            font-size: 0.7rem;
            color: var(--muted)
        }

        .achieve .reward {
            font-size: 0.7rem;
            color: var(--gold)
        }

        .npc {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px;
            margin-bottom: 6px
        }

        .npc .ic {
            font-size: 1.5rem
        }

        .npc .info {
            flex: 1
        }

        .npc .nm {
            font-weight: 600;
            font-size: 0.85rem
        }

        .npc .rate {
            font-size: 0.7rem;
            color: var(--muted)
        }

        .tip {
            position: fixed;
            background: var(--card);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 150;
            max-width: 200px;
            font-size: 0.8rem;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s
        }

        .tip.show {
            opacity: 1
        }

        .tip h4 {
            margin-bottom: 4px
        }

        .tip p {
            color: var(--muted);
            font-size: 0.7rem
        }

        .tut {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .tut-box {
            background: var(--card);
            border-radius: var(--r);
            padding: 24px;
            text-align: center;
            max-width: 320px
        }

        .tut-box h2 {
            margin-bottom: 12px
        }

        .tut-box p {
            color: var(--muted);
            margin-bottom: 16px;
            font-size: 0.9rem
        }

        .tut-box button {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--green), #22c55e);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer
        }

        .notif {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--card);
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1100;
            font-size: 0.8rem;
            transform: translateX(120%);
            transition: 0.3s;
            border-left: 3px solid var(--blue)
        }

        .notif.show {
            transform: translateX(0)
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.3)
            }

            50% {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.6)
            }
        }

        @keyframes pop {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.15)
            }

            100% {
                transform: scale(1)
            }
        }

        .pop {
            animation: pop 0.15s ease
        }

        /* Floating text animation */
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-60px) scale(1.2);
            }
        }

        .float-text {
            position: fixed;
            pointer-events: none;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--green);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: floatUp 1s ease-out forwards;
        }

        .float-text.sell {
            color: var(--gold);
        }

        /* Inventory Grid View */
        .inv-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .inv-grid .inv-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 6px;
            background: var(--bg2);
            border-radius: 8px;
            text-align: center;
        }

        .inv-grid .inv-item .ic {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .inv-grid .inv-item .qty {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--blue);
        }

        .inv-grid .inv-item .val {
            font-size: 0.65rem;
            color: var(--muted);
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .view-toggle button {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: var(--bg2);
            color: var(--text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-toggle button.active {
            background: var(--gold);
            color: var(--bg);
        }

        .category-header {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            padding: 8px 0 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
        }

        /* Modal transitions */
        .modal {
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal.show {
            animation: fadeInScale 0.2s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Button press animation */
        .btn:active {
            transform: scale(0.95);
        }

        /* Smooth hover transition */
        .btn {
            transition: all 0.15s ease;
        }

        /* Smooth progress bar */
        .progress-ring-inner {
            transition: background 0.3s ease;
        }

        .sub .bar div {
            transition: width 0.3s ease-out;
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUpIn 0.5s ease;
        }

        @keyframes slideUpIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .login-box h2 {
            font-size: 1.5rem;
            margin: 0 0 20px 0;
            color: #2d3748;
        }

        .login-subtitle {
            color: #718096;
            margin: 0 0 30px 0;
            font-size: 1.1rem;
        }

        #login-main-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .login-btn-success {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .login-btn-guest {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            color: white;
        }

        .login-btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .login-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Button pulse on success */
        @keyframes successPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px 10px rgba(74, 222, 128, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .success-pulse {
            animation: successPulse 0.4s ease;
        }

        /* Shake animation for errors */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        /* Harvest ready glow - only when full */
        .sub.ready {
            animation: glow 2s infinite;
        }

        /* Light Theme */
        body.light {
            --bg: #f5f5f5;
            --bg2: #ffffff;
            --card: #e8e8e8;
            --hover: #d0d0d0;
            --text: #1a1a2e;
            --muted: #666677;
        }

        /* Font size scaling */
        body.font-small {
            font-size: 14px;
        }

        body.font-normal {
            font-size: 16px;
        }

        body.font-large {
            font-size: 18px;
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg2) 25%, var(--card) 50%, var(--bg2) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Menu Modal */
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .menu-overlay.active {
            display: block;
        }

        .menu-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            min-width: 300px;
            max-width: 90%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
        }

        .menu-modal.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--bg2);
            padding-bottom: 10px;
        }

        .menu-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .menu-item {
            background: var(--bg2);
            border: none;
            padding: 15px;
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: var(--bg3);
        }
    </style>
</head>

<body>
    <div id="app">
        <header class="stats">
            <div class="stat">üí∞ <b id="money">$0</b></div>
            <div class="stat inv">üì¶ <b id="inv">0</b></div>
            <div class="stat" style="font-size:0.65rem;color:var(--muted)" id="save-indicator">üíæ Saved</div>
            <button style="background:var(--card);border:none;padding:6px 10px;border-radius:6px;cursor:pointer"
                id="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        </header>
        <div class="main" id="main"></div>
        <nav class="nav">
            <button data-s="home" id="nav-1" onclick="showHome()"><span class="num">1</span><span
                    class="lbl">Home</span></button>
            <button data-s="inventory" id="nav-2" onclick="showInventory()"><span class="num">2</span><span
                    class="lbl">Inventory</span></button>
            <button data-s="workers" onclick="showWorkers()"><span class="num">3</span><span
                    class="lbl">Workers</span></button>
            <button data-s="player" onclick="showPlayerMarket()"><span class="num">4</span><span
                    class="lbl">Market</span></button>
            <button data-s="chat" onclick="showChat()"><span class="num">5</span><span class="lbl">Chat</span></button>
        </nav>
    </div>

    <!-- Login Screen (shows on startup) -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <h1>üå≤ Tappy Trade</h1>
            <p class="login-subtitle">Build your trading empire!</p>

            <!-- Main buttons -->
            <div id="login-main-buttons">
                <button class="login-btn login-btn-primary" onclick="showLoginForm()">üîë Login</button>
                <button class="login-btn login-btn-success" onclick="showRegisterForm()">‚ú® Create Account</button>
                <button class="login-btn login-btn-guest" onclick="continueAsGuest()">üë§ Continue as Guest</button>
            </div>

            <!-- Login Form (hidden initially) -->
            <div id="login-form-container" style="display:none">
                <h2>üîë Login</h2>
                <input type="text" id="login-username" placeholder="Username" class="login-input">
                <input type="password" id="login-password" placeholder="Password" class="login-input">
                <div class="login-form-actions">
                    <button class="login-btn login-btn-primary" onclick="handleLogin()">Login</button>
                    <button class="login-btn login-btn-secondary" onclick="backToMainLogin()">Back</button>
                </div>
            </div>

            <!-- Register Form (hidden initially) -->
            <div id="register-form-container" style="display:none">
                <h2>‚ú® Create Account</h2>
                <input type="text" id="register-username" placeholder="Username" class="login-input">
                <input type="password" id="register-password" placeholder="Password" class="login-input">
                <input type="password" id="register-confirm" placeholder="Confirm Password" class="login-input">
                <div class="login-form-actions">
                    <button class="login-btn login-btn-success" onclick="handleRegister()">Create Account</button>
                    <button class="login-btn login-btn-secondary" onclick="backToMainLogin()">Back</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="modal" id="build-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üèóÔ∏è Build</h3><button class="modal-close" onclick="closeBuild()">√ó</button>
            </div>
            <div class="modal-body" id="build-list"></div>
        </div>
    </div>
    <div class="modal" id="menu-modal">
        <div class="modal-box" style="padding:16px">
            <div class="modal-head">
                <h3>‚ò∞ Menu</h3><button class="modal-close" onclick="closeMenu()">√ó</button>
            </div>
            <div id="account-status"
                style="margin-bottom:12px;padding:10px;background:var(--bg2);border-radius:8px;font-size:0.85rem"></div>
            <div
                style="margin-bottom:12px;padding:10px;background:var(--bg2);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-size:0.7rem;color:var(--muted);margin-bottom:4px">Farm Name</div>
                    <div id="farm-name-display"
                        style="font-weight:600;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                    </div>
                </div>
                <button class="btn" onclick="renameFarm()" style="font-size:0.7rem">‚úèÔ∏è Rename</button>
            </div>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showStats()">üìä Statistics</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showGovernmentDev()">üèõÔ∏è
                Government</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showHelp()">‚ùì Help</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showSuggestions()">üí°
                Send Suggestion</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showAchievements()">üèÜ
                Achievements</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showDaily()">üéÅ Daily Rewards</button>
            <button class="btn purple" style="width:100%;margin-bottom:8px" id="sound-btn">üîä Sound ON</button>
            <button class="btn" style="width:100%;margin-bottom:8px" id="theme-btn" onclick="toggleTheme()">üåô Dark
                Mode</button>
            <div style="margin-bottom:8px;display:flex;gap:4px;align-items:center">
                <span style="font-size:0.75rem;color:var(--muted)">Font:</span>
                <button class="btn" style="flex:1;font-size:0.75rem" onclick="setFontSize('small')">A-</button>
                <button class="btn" style="flex:1;font-size:0.75rem" onclick="setFontSize('normal')">A</button>
                <button class="btn" style="flex:1;font-size:0.75rem" onclick="setFontSize('large')">A+</button>
            </div>
            <button class="btn" style="width:100%;margin-bottom:8px" id="account-btn" onclick="showAccount()">üë§
                Account</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showLeaderboard()">üèÖ Leaderboard</button>
            <button class="btn green" style="width:100%;margin-bottom:8px" onclick="showPriceList()">üí∞ Price
                List</button>
            <button class="btn red" style="width:100%" data-action="reset-game">üóëÔ∏è Reset Game</button>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div class="modal" id="suggestions-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üí° Send Suggestion</h3><button class="modal-close" onclick="closeSuggestions()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color:var(--muted);font-size:0.85rem;margin-bottom:12px">Got an idea to make Tappy Trade
                    better? Let us know!</p>
                <textarea id="suggestion-text" placeholder="Type your suggestion here..."
                    style="width:100%;min-height:120px;padding:12px;background:var(--bg2);color:var(--text);border:1px solid rgba(255,255,255,0.1);border-radius:8px;font-family:inherit;font-size:0.9rem;resize:vertical"></textarea>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div class="modal" id="account-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üë§ Account</h3><button class="modal-close" onclick="closeAccount()">√ó</button>
            </div>
            <div class="modal-body" id="account-body">
                <div id="login-form">
                    <p style="color:var(--muted);font-size:0.8rem;margin-bottom:12px">Create an account to chat with
                        other players!</p>
                    <input type="text" id="auth-user" placeholder="Username"
                        style="width:100%;padding:10px;margin-bottom:8px;border-radius:6px;background:var(--bg2);color:var(--text);border:none">
                    <div style="position:relative;margin-bottom:12px">
                        <input type="password" id="auth-pass" placeholder="Password"
                            style="width:100%;padding:10px;padding-right:40px;border-radius:6px;background:var(--bg2);color:var(--text);border:none">
                        <button onclick="togglePasswordVisibility()" type="button"
                            style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.2rem"
                            title="Show/Hide Password">üëÅÔ∏è</button>
                    </div>
                    <label
                        style="display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer;font-size:0.9rem">
                        <input type="checkbox" id="remember-me" checked style="width:16px;height:16px;cursor:pointer">
                        <span>Remember Me</span>
                    </label>
                    <button class="btn green" style="width:100%;margin-bottom:8px" onclick="registerAccount()">Create
                        Account</button>
                    <button class="btn purple" style="width:100%" onclick="loginAccount()">Log In</button>
                </div>
                <div id="logged-in" style="display:none">
                    <p style="margin-bottom:12px">Logged in as: <b id="display-name"></b></p>
                    <button class="btn red" style="width:100%" onclick="logoutAccount()">Log Out</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Chat Modal -->
    <div class="modal" id="chat-modal">
        <div class="modal-box" style="height:70vh;display:flex;flex-direction:column">
            <div class="modal-head" style="flex-shrink:0">
                <h3>üí¨ Chat</h3><button class="modal-close" onclick="closeChat()">√ó</button>
            </div>
            <div id="chat-messages"
                style="flex:1;overflow-y:auto;padding:10px;background:var(--bg);border-radius:8px;margin:10px">
                <div class="empty">Connecting...</div>
            </div>
            <div style="padding:10px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:8px">
                <input type="text" id="chat-input" placeholder="Type a message..."
                    style="flex:1;padding:10px;border-radius:6px;background:var(--bg2);color:var(--text);border:none">
                <button class="btn green" onclick="sendChat()">Send</button>
            </div>
        </div>
    </div>
    <!-- Daily Rewards Modal -->
    <!-- Global Wrappers for Login Actions (Pre-load shims) -->
    <script>
        // Simple shims for login buttons to prevent errors if clicked early
        window.continueAsGuest = () => { if (window.convertGuestToAccount) window.continueAsGuest(); else console.log('‚è≥ Waiting for game load...'); };
        window.loginAccount = () => { if (window.handleLogin) window.loginAccount(); else console.log('‚è≥ Waiting for game load...'); };
        window.registerAccount = () => { if (window.handleRegister) window.registerAccount(); else console.log('‚è≥ Waiting for game load...'); };
    </script>
    <div class="modal" id="daily-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üéÅ Daily Rewards</h3><button class="modal-close" onclick="closeDaily()">√ó</button>
            </div>
            <div class="modal-body" id="daily-body">
                <p style="text-align:center;color:var(--muted);margin-bottom:12px">Come back every day for bigger
                    rewards!</p>
                <div id="daily-calendar"
                    style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:16px"></div>
                <div style="text-align:center">
                    <p id="daily-streak" style="margin-bottom:12px;font-size:0.9rem"></p>
                    <button class="btn green" id="claim-daily-btn" onclick="claimDaily()"
                        style="width:100%;padding:14px;font-size:1rem">üéÅ Claim Today's Reward</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Leaderboard Modal -->
    <div class="modal" id="leaderboard-modal">
        <div class="modal-box" style="max-height:80vh">
            <div class="modal-head">
                <h3>üèÖ Leaderboard</h3><button class="modal-close" onclick="closeLeaderboard()">√ó</button>
            </div>
            <div class="modal-body" id="leaderboard-body" style="overflow-y:auto;max-height:60vh">
                <div class="empty">Loading...</div>
            </div>
        </div>
    </div>
    <div class="tip" id="tip"></div>
    <div class="notif" id="notif-container"></div>
    <div class="tut" id="tutorial" style="display:none">
        <div class="tut-box">
            <h2>üå≤ Welcome!</h2>
            <p>Tap plots to harvest resources.<br>Sell at market to earn money.<br>Hold 3s on a plot to build.</p>
            <button onclick="closeTutorial()">Start Playing!</button>
        </div>
    </div>

    <!-- Government Development Modal -->
    <div class="modal" id="gov-dev-modal">
        <div class="modal-box">
            <div class="modal-header">
                <span>üèõÔ∏è Government Development</span>
                <button class="modal-close" onclick="closeGovernmentDev()">‚úï</button>
            </div>
            <div class="modal-body" id="gov-dev-content">
                <!-- Content populated by governmentDev.js -->
            </div>
        </div>
    </div>

    <script type="module">
        // Import main module which loads all config, utilities, and core systems
        import './js/main.js';

        console.log('‚úÖ Module script executing - import completed');

        // Note: R, T, B, PLOTS, ACH, CONFIG, etc. are now imported via main.js
        // All functions are exported to window object by main.js

        // MOBILE FIX: Initialize game when modules are ready
        function initializeGame() {
            console.log('üéÆ Initializing game...');

            // Check if window.init exists (exported from main.js)
            if (typeof window.init === 'function') {
                // Ensure DOM is ready before calling init
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        window.init();
                        console.log('‚úÖ Game initialized successfully (after DOMContentLoaded)');
                    });
                } else {
                    window.init();
                    console.log('‚úÖ Game initialized successfully');
                }
            } else {
                console.error('‚ùå window.init not found!');
            }
        }

        // MOBILE FIX & LOGIN SCREEN: Race condition fix - imports execute synchronously!
        // By the time this line runs, main.js has ALREADY dispatched modulesReady
        // So we check if init is available immediately instead of waiting for an event

        // LOGIN SCREEN CHECK: Only auto-init if NOT showing login screen
        if (typeof window.shouldShowLoginScreen === 'function' && window.shouldShowLoginScreen()) {
            console.log('üîê Login screen will be shown - skipping auto-init');
            // Login screen is shown, user will manually trigger init after logging in
        } else {
            initializeGame();
        }
    </script>
    <script>


        // Variables that were in modules are now available globally via window
        // Examples: window.R, window.T, window.B, window.S, window.save, window.ACH, etc.

        // Continue with remaining game code below...
        // (Note: ACH array is now loaded from achievements module)
        // (Note: EVENTS and DAILY_REWARDS are now loaded from constants module)

        // Game version, save version, CONFIG, and game state (S) all from modules
        // migrateSave, save, load functions also from modules

        // Current UI screen
        const $ = id => document.getElementById(id);


        // Global hold detection for building modal
        let holdTarget = null;
        let holdTimer = null;
        let holdStart = 0;

        document.addEventListener('mousedown', (e) => {
            const sub = e.target.closest('.sub');
            if (!sub) return;
            holdTarget = sub;
            holdStart = Date.now();
            holdTimer = setTimeout(() => {
                if (holdTarget === sub) {
                    openBuild(+sub.dataset.p, +sub.dataset.s);
                    holdTarget = null;
                }
            }, 500); // Hold for 500ms to open build modal
        });

        document.addEventListener('mouseup', () => {
            clearTimeout(holdTimer);
            holdTarget = null;
        });



        document.addEventListener('touchstart', (e) => {
            const sub = e.target.closest('.sub');
            if (!sub) return;
            holdTarget = sub;
            holdStart = Date.now();
            holdTimer = setTimeout(() => {
                if (holdTarget === sub) {
                    openBuild(+sub.dataset.p, +sub.dataset.s);
                    holdTarget = null;
                }
            }, 3000);
        }, { passive: true });

        document.addEventListener('touchend', () => {
            clearTimeout(holdTimer);
            holdTarget = null;
        });


        // ===== GOVERNMENT MARKET MOVED TO js/ui/markets.js (Phase 2M) =====



        // ===== CHAT SYSTEM MOVED TO js/multiplayer/chat.js (Phase 2I) =====
        // All chat functions (showChat, sendChat, renderChat) now in module


        // ===== STATS SCREEN MOVED TO js/ui/stats.js (Phase 2L) =====

        // ===== FIREBASE CONFIG =====
        // Firebase now initialized in <head> before modules load
        // const firebaseConfig = { ... }


        let db = window.db; // Use the db initialized in head
        let auth = firebase.auth();
        let unsubOrders = null;

        // Helper shims until main.js loads
        if (!window.notif) window.notif = (m) => console.log('üîî [Deferred]', m);
        if (!window.toast) window.toast = (m) => console.log('üçû [Deferred]', m);

        // Expose to window for markets.js module
        window.userId = null;
        window.orders = [];

        async function initFirebase() {
            try {
                // firebase.initializeApp() already called in <head>
                // db = firebase.firestore(); // Already set as window.db
                auth = firebase.auth();

                // Anonymous sign in
                const result = await auth.signInAnonymously();
                window.userId = result.user.uid;
                console.log('Firebase connected, user:', window.userId);
                notif('üåê Connected to market!');

                // Listen for orders
                unsubOrders = db.collection('orders')
                    .where('status', '==', 'open')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .onSnapshot(snap => {
                        window.orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Check if we're on the player market screen before re-rendering
                        if (window.getScreen && window.getScreen() === 'player') {
                            window.render();
                        }
                    });

                // Load cloud save if logged in
                if (loggedInUser) {
                    const loaded = await loadFromCloud();
                    if (loaded) {
                        notif('‚òÅÔ∏è Cloud progress loaded!');
                        render();
                    }
                }
            } catch (e) {
                console.error('Firebase error:', e);
                toast('Market offline', 'err');
            }
        }
        console.log('üî• About to call initFirebase...');
        initFirebase(); // Initialize Firebase and connect to market


        // ===== ACCOUNT SYSTEM (Firestore-based) =====
        let userName = 'Guest';
        let loggedInUser = null; // { username, id }
        let unsubChat = null;
        let chatMessages = [];



        // =====HELP SCREEN MOVED TO js/ui/help.js (Phase 2K)=====

        // Background music
        let bgMusic = null;
        let musicStarted = false;

        function initMusic() {
            // Prevent multiple initializations
            if (bgMusic) return;

            // Randomize between two tracks
            const tracks = [
                [
                    'music/Little Jam.mp3',
                    './music/Little Jam.mp3',
                    '/music/Little Jam.mp3',
                    'public/music/Little Jam.mp3',
                    './public/music/Little Jam.mp3'
                ],
                [
                    'music/Little Jam 2.mp3',
                    './music/Little Jam 2.mp3',
                    '/music/Little Jam 2.mp3',
                    'public/music/Little Jam 2.mp3',
                    './public/music/Little Jam 2.mp3'
                ]
            ];

            const MUSIC_CANDIDATES = tracks[Math.floor(Math.random() * tracks.length)];
            let musicIdx = 0;
            bgMusic = new Audio(MUSIC_CANDIDATES[musicIdx]);
            bgMusic.loop = true;
            bgMusic.volume = 0.3;
            bgMusic.muted = !S.sound;
            bgMusic.preload = 'auto';

            const tryNextSource = () => {
                musicIdx++;
                if (musicIdx >= MUSIC_CANDIDATES.length) {
                    console.log('Music file not found in any location');
                    return;
                }
                bgMusic.src = MUSIC_CANDIDATES[musicIdx];
                bgMusic.load();
            };

            bgMusic.addEventListener('error', () => {
                tryNextSource();
            });

            const tryPlay = async () => {
                if (musicStarted) return true;
                if (!S.sound) return false;
                bgMusic.muted = false;
                try {
                    await bgMusic.play();
                    musicStarted = true;
                    return true;
                } catch (e) {
                    console.log('Music autoplay blocked:', e.name);
                    return false;
                }
            };

            // Start on first user interaction - iOS requires touchend, not touchstart
            const startMusic = () => {
                if (musicStarted) {
                    removeListeners();
                    return;
                }
                tryPlay().then((started) => {
                    if (started) {
                        removeListeners();
                    }
                });
            };

            const removeListeners = () => {
                document.removeEventListener('click', startMusic);
                document.removeEventListener('touchstart', startMusic);
                document.removeEventListener('touchend', startMusic);
                document.removeEventListener('keydown', startMusic);
            };

            // Allow other UI (like sound toggle) to trigger play
            window.__ttStartMusic = startMusic;

            // Multiple event types for better mobile compatibility
            document.addEventListener('click', startMusic);
            document.addEventListener('touchstart', startMusic, { passive: true });
            document.addEventListener('touchend', startMusic, { passive: true });
            document.addEventListener('keydown', startMusic);
        }

        // ===== SERVICE WORKER TEMPORARILY DISABLED =====
        /*
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
        .then((registration) => {
        console.log('‚úÖ Service Worker registered successfully');

        // Helper function to safely check for updates
        const checkForUpdate = () => {
        if (registration && registration.active) {
        registration.update().catch(err => {
        // Silently ignore update errors to avoid spam
        console.debug('Update check skipped:', err.message);
        });
        }
        };

        // Check for updates every 5 minutes
        setInterval(checkForUpdate, 300000); // 5 minutes

        // Check when user returns to the app
        document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
        checkForUpdate();
        }
        });

        // Check when app gains focus
        window.addEventListener('focus', checkForUpdate);

        // Listen for updates
        registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;

        newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
        // New version available - auto reload after 3 seconds
        console.log('üéâ New version found! Auto-updating in 3 seconds...');
        setTimeout(() => {
        newWorker.postMessage({ type: 'SKIP_WAITING' });
        window.location.reload();
        }, 3000);
        }
        });
        });
        })
        .catch((error) => {
        console.log('‚ùå Service Worker registration failed:', error);
        });
        }
        */
        console.log('‚ö†Ô∏è Service Worker DISABLED - Fresh files will load');

        // Debug: Check close button CSS
        setTimeout(() => {
            const closeBtn = document.querySelector('.modal-close');
            if (closeBtn) {
                const styles = window.getComputedStyle(closeBtn);
                console.log('üîµ [DEBUG] Close button CSS:');
                console.log(' - Background:', styles.backgroundColor);
                console.log(' - Color:', styles.color);
                console.log(' - Border:', styles.border);
                console.log(' - Expected: RGB(239, 68, 68) bright red');
            }
        }, 1000);

        // Helper functions that were deleted as duplicates
        function togglePasswordVisibility() {
            const passInput = document.getElementById('auth-pass');
            const toggleBtn = event.target;
            if (!passInput) return;

            if (passInput.type === 'password') {
                passInput.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }

        // All initialization now handled by main.js
        // window exports are handled by main.js
        window.addEventListener('modulesReady', () => {
            console.log('üöÄ Modules ready, initializing game...');
            // Initialize game if not blocked by login screen
            if (window.init && typeof window.shouldShowLoginScreen === 'function' && !window.shouldShowLoginScreen()) {
                window.init();
            }
        });
    </script>
</body>

</html>```