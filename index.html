<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tappy Trade</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg: #0f0f1a;
            --bg2: #1a1a2e;
            --card: #252542;
            --hover: #2d2d4a;
            --gold: #ffd700;
            --green: #4ade80;
            --blue: #60a5fa;
            --purple: #a78bfa;
            --red: #f87171;
            --orange: #fb923c;
            --text: #fff;
            --muted: #6b6b7b;
            --nav: 70px;
            --r: 12px
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%;
            overflow: hidden
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            user-select: none;
            -webkit-tap-highlight-color: transparent
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg2)
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1)
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem
        }

        .stat b {
            color: var(--gold)
        }

        .stat.inv b {
            color: var(--blue)
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            height: var(--nav);
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100
        }

        .nav button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            background: var(--card);
            border: none;
            border-radius: var(--r);
            color: var(--muted);
            cursor: pointer;
            font-family: inherit;
            transition: 0.2s
        }

        .nav button:hover {
            background: var(--hover);
            color: var(--text)
        }

        .nav button.active {
            background: linear-gradient(135deg, var(--purple), #8b5cf6);
            color: #fff
        }

        .nav .num {
            font-size: 1rem;
            font-weight: 700
        }

        .nav .lbl {
            font-size: 0.55rem;
            text-transform: uppercase
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            padding-bottom: calc(var(--nav) + 16px)
        }

        .plot {
            background: var(--card);
            border-radius: var(--r);
            padding: 10px;
            margin-bottom: 10px
        }

        .subs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px
        }

        .sub {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 6px;
            background: var(--bg2);
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.15s;
            min-height: 85px
        }

        .sub:hover {
            background: var(--hover)
        }

        .sub:active {
            transform: scale(0.96)
        }

        .sub.ready {
            border-color: var(--green)
        }

        .sub .icon {
            font-size: 1.8rem
        }

        .sub .cnt {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--green);
            color: var(--bg);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 8px
        }

        .sub .cnt.zero {
            background: var(--muted)
        }

        .sub .bar {
            width: 100%;
            height: 3px;
            background: var(--bg);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden
        }

        .sub .bar div {
            height: 100%;
            background: var(--green);
            transition: width 0.3s
        }

        .sub .lvl {
            position: absolute;
            bottom: 2px;
            left: 2px;
            font-size: 0.55rem;
            color: var(--purple);
            font-weight: 600
        }

        .sub.building {
            border-color: var(--purple)
        }

        .sub.building .cnt {
            background: var(--purple)
        }

        .locked {
            background: rgba(37, 37, 66, 0.5);
            border: 2px dashed var(--muted);
            text-align: center;
            padding: 24px;
            cursor: pointer
        }

        .locked:hover {
            border-color: var(--gold)
        }

        .locked.can {
            animation: glow 2s infinite
        }

        .locked h4 {
            color: var(--gold);
            font-size: 1.2rem;
            margin: 6px 0
        }

        .locked button {
            margin-top: 10px;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--gold), #ff9500);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer
        }

        .locked button:disabled {
            background: var(--hover);
            color: var(--muted);
            cursor: not-allowed
        }

        .screen {
            display: none
        }

        .screen.active {
            display: block
        }

        .panel {
            background: var(--card);
            border-radius: var(--r);
            padding: 16px;
            margin-bottom: 12px
        }

        .panel h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px
        }

        .item .ic {
            font-size: 1.3rem
        }

        .item .nm {
            flex: 1;
            font-size: 0.9rem
        }

        .item .qt {
            font-weight: 700;
            color: var(--blue);
            min-width: 40px;
            text-align: right
        }

        .item .pr {
            font-size: 0.75rem;
            color: var(--green)
        }

        .btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--gold), #ff9500);
            color: var(--bg);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer
        }

        .btn:hover {
            transform: scale(1.03)
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none
        }

        .btn.red {
            background: linear-gradient(135deg, var(--red), #dc2626)
        }

        .btn.green {
            background: linear-gradient(135deg, var(--green), #22c55e)
        }

        .btn.purple {
            background: linear-gradient(135deg, var(--purple), #8b5cf6)
        }

        .empty {
            text-align: center;
            padding: 30px;
            color: var(--muted)
        }

        .toast {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: var(--card);
            padding: 10px 18px;
            border-radius: 8px;
            opacity: 0;
            transition: 0.3s;
            z-index: 1000;
            font-size: 0.85rem;
            border-left: 3px solid var(--blue)
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0)
        }

        .toast.ok {
            border-color: var(--green)
        }

        .toast.err {
            border-color: var(--red)
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto
        }

        .modal-box {
            background: var(--card);
            border-radius: var(--r);
            width: 90%;
            max-width: 380px;
            max-height: 80vh;
            overflow-y: auto
        }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: var(--card)
        }

        .modal-head h3 {
            font-size: 1rem
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--muted);
            cursor: pointer
        }

        .modal-close:hover {
            color: var(--red)
        }

        .modal-body {
            padding: 14px
        }

        .cat {
            margin-bottom: 16px
        }

        .cat-title {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px
        }

        .bld {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: 0.2s
        }

        .bld:hover {
            background: var(--hover)
        }

        .bld.off {
            opacity: 0.5;
            cursor: not-allowed
        }

        .bld .ic {
            font-size: 1.6rem
        }

        .bld .info {
            flex: 1
        }

        .bld .nm {
            font-weight: 600;
            font-size: 0.9rem
        }

        .bld .prod {
            font-size: 0.7rem;
            color: var(--green)
        }

        .bld .cost {
            font-size: 0.65rem;
            color: var(--muted)
        }

        .bld .cost .m {
            color: var(--gold)
        }

        .bld .cost .r {
            color: var(--blue)
        }

        .achieve {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px;
            margin-bottom: 6px
        }

        .achieve.done {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--green)
        }

        .achieve .ic {
            font-size: 1.5rem
        }

        .achieve .info {
            flex: 1
        }

        .achieve .nm {
            font-weight: 600;
            font-size: 0.85rem
        }

        .achieve .desc {
            font-size: 0.7rem;
            color: var(--muted)
        }

        .achieve .reward {
            font-size: 0.7rem;
            color: var(--gold)
        }

        .npc {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg2);
            border-radius: 8px;
            margin-bottom: 6px
        }

        .npc .ic {
            font-size: 1.5rem
        }

        .npc .info {
            flex: 1
        }

        .npc .nm {
            font-weight: 600;
            font-size: 0.85rem
        }

        .npc .rate {
            font-size: 0.7rem;
            color: var(--muted)
        }

        .tip {
            position: fixed;
            background: var(--card);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 150;
            max-width: 200px;
            font-size: 0.8rem;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s
        }

        .tip.show {
            opacity: 1
        }

        .tip h4 {
            margin-bottom: 4px
        }

        .tip p {
            color: var(--muted);
            font-size: 0.7rem
        }

        .tut {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .tut-box {
            background: var(--card);
            border-radius: var(--r);
            padding: 24px;
            text-align: center;
            max-width: 320px
        }

        .tut-box h2 {
            margin-bottom: 12px
        }

        .tut-box p {
            color: var(--muted);
            margin-bottom: 16px;
            font-size: 0.9rem
        }

        .tut-box button {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--green), #22c55e);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer
        }

        .notif {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--card);
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 150;
            font-size: 0.8rem;
            transform: translateX(120%);
            transition: 0.3s;
            border-left: 3px solid var(--blue)
        }

        .notif.show {
            transform: translateX(0)
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.3)
            }

            50% {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.6)
            }
        }

        @keyframes pop {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.15)
            }

            100% {
                transform: scale(1)
            }
        }

        .pop {
            animation: pop 0.15s ease
        }

        /* Floating text animation */
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-60px) scale(1.2);
            }
        }

        .float-text {
            position: fixed;
            pointer-events: none;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--green);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: floatUp 1s ease-out forwards;
        }

        .float-text.sell {
            color: var(--gold);
        }

        /* Smooth progress bar */
        .sub .bar div {
            transition: width 0.3s ease-out;
        }

        /* Button pulse on success */
        @keyframes successPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px 10px rgba(74, 222, 128, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .success-pulse {
            animation: successPulse 0.4s ease;
        }

        /* Shake animation for errors */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        /* Harvest ready glow */
        .sub.ready {
            animation: glow 2s infinite;
        }
    </style>
</head>

<body>
    <div id="app">
        <header class="stats">
            <div class="stat">üí∞ <b id="money">$0</b></div>
            <div class="stat inv">üì¶ <b id="inv">0</b></div>
            <button style="background:var(--card);border:none;padding:6px 10px;border-radius:6px;cursor:pointer"
                id="menu-btn">‚ò∞</button>
        </header>
        <div class="main" id="main"></div>
        <nav class="nav">
            <button data-s="home" id="nav-1" class="active"><span class="num">1</span><span class="lbl"
                    id="nav-1-label">Inventory</span></button>
            <button data-s="workers"><span class="num">2</span><span class="lbl">Workers</span></button>
            <button data-s="player"><span class="num">3</span><span class="lbl">Trade</span></button>
            <button data-s="market"><span class="num">4</span><span class="lbl">Gov</span></button>
            <button data-s="stats"><span class="num">5</span><span class="lbl">Stats</span></button>
        </nav>
    </div>
    <div class="toast" id="toast"></div>
    <div class="modal" id="build-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üèóÔ∏è Build</h3><button class="modal-close" onclick="closeBuild()">√ó</button>
            </div>
            <div class="modal-body" id="build-list"></div>
        </div>
    </div>
    <div class="modal" id="menu-modal">
        <div class="modal-box" style="padding:16px">
            <h3 style="margin-bottom:12px">‚ò∞ Menu</h3>
            <div id="account-status"
                style="margin-bottom:12px;padding:10px;background:var(--bg2);border-radius:8px;font-size:0.85rem"></div>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showAchievements()">üèÜ
                Achievements</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showDaily()">üéÅ Daily Rewards</button>
            <button class="btn purple" style="width:100%;margin-bottom:8px" id="sound-btn">üîä Sound ON</button>
            <button class="btn purple" style="width:100%;margin-bottom:8px" onclick="showChat()">üí¨ Chat</button>
            <button class="btn" style="width:100%;margin-bottom:8px" id="account-btn" onclick="showAccount()">üë§
                Account</button>
            <button class="btn" style="width:100%;margin-bottom:8px" onclick="showLeaderboard()">üèÖ Leaderboard</button>
            <button class="btn red" style="width:100%" onclick="resetGame()">üóëÔ∏è Reset Game</button>
            <button class="btn" style="width:100%;margin-top:8px;background:var(--bg2)"
                onclick="closeMenu()">Close</button>
        </div>
    </div>
    <div class="modal" id="achieve-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üèÜ Achievements</h3><button class="modal-close" onclick="closeAchieve()">√ó</button>
            </div>
            <div class="modal-body" id="achieve-list"></div>
        </div>
    </div>
    <!-- Account Modal -->
    <div class="modal" id="account-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üë§ Account</h3><button class="modal-close" onclick="closeAccount()">√ó</button>
            </div>
            <div class="modal-body" id="account-body">
                <div id="login-form">
                    <p style="color:var(--muted);font-size:0.8rem;margin-bottom:12px">Create an account to chat with
                        other players!</p>
                    <input type="text" id="auth-name" placeholder="Username"
                        style="width:100%;padding:10px;margin-bottom:8px;border-radius:6px;background:var(--bg2);color:var(--text);border:none">
                    <input type="password" id="auth-pass" placeholder="Password"
                        style="width:100%;padding:10px;margin-bottom:12px;border-radius:6px;background:var(--bg2);color:var(--text);border:none">
                    <button class="btn green" style="width:100%;margin-bottom:8px" onclick="registerAccount()">Create
                        Account</button>
                    <button class="btn purple" style="width:100%" onclick="loginAccount()">Log In</button>
                </div>
                <div id="logged-in" style="display:none">
                    <p style="margin-bottom:12px">Logged in as: <b id="display-name"></b></p>
                    <button class="btn red" style="width:100%" onclick="logoutAccount()">Log Out</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Chat Modal -->
    <div class="modal" id="chat-modal">
        <div class="modal-box" style="height:70vh;display:flex;flex-direction:column">
            <div class="modal-head" style="flex-shrink:0">
                <h3>üí¨ Chat</h3><button class="modal-close" onclick="closeChat()">√ó</button>
            </div>
            <div class="modal-body" style="flex:1;overflow-y:auto;padding:10px" id="chat-messages">
                <div class="empty">Connecting to chat...</div>
            </div>
            <div style="padding:10px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:8px">
                <input type="text" id="chat-input" placeholder="Type a message..."
                    style="flex:1;padding:10px;border-radius:6px;background:var(--bg2);color:var(--text);border:none">
                <button class="btn green" onclick="sendChat()">Send</button>
            </div>
        </div>
    </div>
    <!-- Daily Rewards Modal -->
    <div class="modal" id="daily-modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>üéÅ Daily Rewards</h3><button class="modal-close" onclick="closeDaily()">√ó</button>
            </div>
            <div class="modal-body" id="daily-body">
                <p style="text-align:center;color:var(--muted);margin-bottom:12px">Come back every day for bigger
                    rewards!</p>
                <div id="daily-calendar"
                    style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:16px"></div>
                <div style="text-align:center">
                    <p id="daily-streak" style="margin-bottom:12px;font-size:0.9rem"></p>
                    <button class="btn green" id="claim-daily-btn" onclick="claimDaily()"
                        style="width:100%;padding:14px;font-size:1rem">üéÅ Claim Today's Reward</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Leaderboard Modal -->
    <div class="modal" id="leaderboard-modal">
        <div class="modal-box" style="max-height:80vh">
            <div class="modal-head">
                <h3>üèÖ Leaderboard</h3><button class="modal-close" onclick="closeLeaderboard()">√ó</button>
            </div>
            <div class="modal-body" id="leaderboard-body" style="overflow-y:auto;max-height:60vh">
                <div class="empty">Loading...</div>
            </div>
        </div>
    </div>
    <div class="tip" id="tip"></div>
    <div class="notif" id="notif"></div>
    <div class="tut" id="tutorial" style="display:none">
        <div class="tut-box">
            <h2>üå≤ Welcome!</h2>
            <p>Tap plots to harvest resources.<br>Sell at market to earn money.<br>Hold 3s on a plot to build.</p>
            <button onclick="closeTutorial()">Start Playing!</button>
        </div>
    </div>
    <script>
        const R = { wood: { n: 'Wood', i: 'ü™µ', p: 5 }, berries: { n: 'Berries', i: 'üçá', p: 8 }, herbs: { n: 'Herbs', i: 'üåø', p: 10 }, stone: { n: 'Stone', i: 'ü™®', p: 4 }, wheat: { n: 'Wheat', i: 'üåæ', p: 6 }, potato: { n: 'Potatoes', i: 'ü•î', p: 7 }, carrot: { n: 'Carrots', i: 'ü•ï', p: 7 }, corn: { n: 'Corn', i: 'üåΩ', p: 8 }, soy: { n: 'Soybeans', i: 'ü´ò', p: 9 }, egg: { n: 'Eggs', i: 'ü•ö', p: 12 }, chicken: { n: 'Chicken', i: 'üçó', p: 25 }, milk: { n: 'Milk', i: 'ü•õ', p: 15 }, beef: { n: 'Beef', i: 'ü•©', p: 40 }, leather: { n: 'Leather', i: 'üü´', p: 30 }, wool: { n: 'Wool', i: 'üß∂', p: 20 }, mutton: { n: 'Mutton', i: 'üçñ', p: 35 }, planks: { n: 'Planks', i: 'ü™µ', p: 15 }, flour: { n: 'Flour', i: 'üåæ', p: 18 }, cloth: { n: 'Cloth', i: 'üßµ', p: 50 }, bread: { n: 'Bread', i: 'üçû', p: 25 }, fertilizer: { n: 'Fertilizer', i: 'üí©', p: 50 } };
        const T = { forest: { n: 'Forest', i: 'üå≤', o: 'wood', r: 0.08, m: 30 }, berryBush: { n: 'Berries', i: 'üçá', o: 'berries', r: 0.1, m: 25 }, herbPatch: { n: 'Herbs', i: 'üåø', o: 'herbs', r: 0.06, m: 20 }, quarry: { n: 'Quarry', i: 'ü™®', o: 'stone', r: 0.04, m: 20 }, wheatFarm: { n: 'Wheat', i: 'üåæ', o: 'wheat', r: 0.12, m: 40, b: 1 }, potatoFarm: { n: 'Potato', i: 'ü•î', o: 'potato', r: 0.1, m: 35, b: 1 }, carrotFarm: { n: 'Carrot', i: 'ü•ï', o: 'carrot', r: 0.1, m: 35, b: 1 }, cornFarm: { n: 'Corn', i: 'üåΩ', o: 'corn', r: 0.08, m: 30, b: 1 }, soyFarm: { n: 'Soy', i: 'ü´ò', o: 'soy', r: 0.07, m: 25, b: 1 }, chickenCoop: { n: 'Chickens', i: 'üêî', o: 'egg', r: 0.05, m: 20, b: 1, x: { chicken: 0.01 } }, cowPasture: { n: 'Cows', i: 'üêÑ', o: 'milk', r: 0.03, m: 15, b: 1, x: { beef: 0.005, leather: 0.008 } }, sheepPen: { n: 'Sheep', i: 'üêë', o: 'wool', r: 0.04, m: 18, b: 1, x: { mutton: 0.007 } }, sawmill: { n: 'Sawmill', i: 'üè≠', o: 'planks', m: 15, b: 1, req: 'wood', use: 2, tap: 1 }, mill: { n: 'Mill', i: 'üè≠', o: 'flour', m: 20, b: 1, req: 'wheat', use: 3, tap: 1 }, loom: { n: 'Loom', i: 'üßµ', o: 'cloth', m: 10, b: 1, req: 'wool', use: 3, tap: 1 }, bakery: { n: 'Bakery', i: 'ü•ñ', o: 'bread', m: 15, b: 1, req: 'flour', use: 2, tap: 1 }, storage: { n: 'Storage', i: 'üì¶', b: 1, cap: 100 } };
        const B = { farms: [{ t: 'wheatFarm', c: { m: 500, wood: 20 } }, { t: 'potatoFarm', c: { m: 600, wood: 25 } }, { t: 'carrotFarm', c: { m: 600, wood: 25 } }, { t: 'cornFarm', c: { m: 700, wood: 30 } }, { t: 'soyFarm', c: { m: 800, wood: 35 } }], livestock: [{ t: 'chickenCoop', c: { m: 1000, wood: 40, wheat: 20 } }, { t: 'cowPasture', c: { m: 2500, wood: 60, wheat: 50 } }, { t: 'sheepPen', c: { m: 1500, wood: 50, wheat: 30 } }], manufacturing: [{ t: 'sawmill', c: { m: 2000, stone: 50 } }, { t: 'mill', c: { m: 1500, stone: 30, wood: 40 } }, { t: 'loom', c: { m: 3000, wood: 60, stone: 30 } }, { t: 'bakery', c: { m: 2500, stone: 40, wood: 30 } }], utility: [{ t: 'storage', c: { m: 1000, wood: 50 } }] };
        const PLOTS = [0, 5000, 15000, 35000, 75000];
        const ACH = [{ id: 'h100', n: 'Harvester', d: 'Harvest 100 items', g: 100, r: 100 }, { id: 'h1000', n: 'Farmer', d: 'Harvest 1000 items', g: 1000, r: 500 }, { id: 'm1000', n: 'Trader', d: 'Earn $1000', g: 1000, r: 200 }, { id: 'm10000', n: 'Merchant', d: 'Earn $10000', g: 10000, r: 1000 }, { id: 'p2', n: 'Landowner', d: 'Own 2 plots', g: 2, r: 500 }, { id: 'b1', n: 'Builder', d: 'Build 1 building', g: 1, r: 200 }, { id: 'b5', n: 'Architect', d: 'Build 5 buildings', g: 5, r: 1000 }, { id: 'w1', n: 'Employer', d: 'Hire 1 worker', g: 1, r: 300 }];

        // Random Events
        const EVENTS = [
            { id: 'rain', n: 'üåßÔ∏è Rain Bonus', d: 'All farms produce 2x!', duration: 180000, effect: 'farmBoost', mult: 2 },
            { id: 'merchant', n: 'üí∞ Merchant Visit', d: 'Sell prices +50%!', duration: 120000, effect: 'priceBoost', mult: 1.5 },
            { id: 'gold', n: 'üéâ Gold Rush', d: 'Found buried treasure!', duration: 0, effect: 'bonus', amount: 500 },
            { id: 'bountiful', n: 'üåæ Bountiful Harvest', d: 'All resources ready to harvest!', duration: 0, effect: 'fillAll' },
        ];

        // Daily Rewards (7-day cycle)
        const DAILY_REWARDS = [
            { day: 1, reward: 100, desc: '$100' },
            { day: 2, reward: 150, desc: '$150' },
            { day: 3, reward: 200, desc: '$200' },
            { day: 4, reward: 300, desc: '$300' },
            { day: 5, reward: 500, desc: '$500' },
            { day: 6, reward: 750, desc: '$750' },
            { day: 7, reward: 1000, desc: '$1000 üéâ' },
        ];

        const S = { money: 0, inv: {}, cap: 100, sound: 1, plots: [{ subs: [{ t: 'forest', c: 5, lv: 1 }, { t: 'berryBush', c: 4, lv: 1 }, { t: 'herbPatch', c: 3, lv: 1 }] }], workers: [], stats: { harvested: 0, sold: 0, earned: 0, built: 0 }, ach: {}, prices: {}, priceDir: {}, tutorial: 0, lastUpdate: Date.now(), activeEvent: null, eventEndsAt: 0, nextEventAt: Date.now() + 300000, lastDailyReward: 0, dailyStreak: 0 };
        let screen = 'home', buildP = null, buildS = null, tipTimer = null;
        const $ = id => document.getElementById(id);

        function save() {
            S.lastUpdate = Date.now();
            localStorage.setItem('tt4', JSON.stringify(S));
            // Auto-save to cloud if logged in (throttled)
            if (loggedInUser && db && !window._cloudSaving) {
                window._cloudSaveQueued = true;
            }
        }
        function load() { try { const d = JSON.parse(localStorage.getItem('tt4')); if (d) { Object.assign(S, d); return 1 } } catch (e) { } return 0 }

        // Cloud save functions
        async function saveToCloud() {
            if (!loggedInUser || !db) return;
            window._cloudSaving = true;
            try {
                await db.collection('saves').doc(loggedInUser.id).set({
                    state: JSON.stringify(S),
                    username: loggedInUser.username,
                    money: S.money,
                    lastSave: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Cloud save complete');
            } catch (e) {
                console.error('Cloud save failed:', e);
            }
            window._cloudSaving = false;
            window._cloudSaveQueued = false;
        }

        async function loadFromCloud() {
            if (!loggedInUser || !db) return false;
            try {
                const doc = await db.collection('saves').doc(loggedInUser.id).get();
                if (doc.exists) {
                    const data = doc.data();
                    const cloudState = JSON.parse(data.state);

                    // Calculate offline earnings
                    const now = Date.now();
                    const offlineTime = now - cloudState.lastUpdate;

                    // Apply cloud state
                    Object.assign(S, cloudState);

                    // Calculate offline progress (max 8 hours)
                    if (offlineTime > 1000) {
                        const beforeHarvested = S.stats?.harvested || 0;
                        const beforeInv = getInvTotal();
                        update(Math.min(offlineTime, 8 * 3600000));
                        const harvested = (S.stats?.harvested || 0) - beforeHarvested;
                        const gained = getInvTotal() - beforeInv;
                        const hours = Math.floor(offlineTime / 3600000);
                        const mins = Math.floor((offlineTime % 3600000) / 60000);
                        if (hours > 0 || mins > 5) {
                            if (harvested > 0 || gained > 0) {
                                notif(`‚è∞ Offline for ${hours}h ${mins}m ‚Äî workers gathered +${Math.max(0, gained)} items`);
                            } else {
                                notif(`‚è∞ Offline for ${hours}h ${mins}m - resources grew!`);
                            }
                        }
                    }

                    S.lastUpdate = now;
                    save();
                    return true;
                }
            } catch (e) {
                console.error('Cloud load failed:', e);
            }
            return false;
        }

        // Cloud sync interval (every 30 seconds if changes pending)
        setInterval(() => {
            if (window._cloudSaveQueued && loggedInUser && !window._cloudSaving) {
                saveToCloud();
            }
        }, 30000);
        function toast(m, t = '') { const e = $('toast'); e.textContent = m; e.className = 'toast show ' + (t || ''); setTimeout(() => e.classList.remove('show'), 2000) }
        function notif(m) { const e = $('notif'); e.textContent = m; e.classList.add('show'); setTimeout(() => e.classList.remove('show'), 3000) }

        // Floating text animation for harvest/sell feedback
        function floatText(text, x, y, type = '') {
            const el = document.createElement('div');
            el.className = 'float-text ' + type;
            el.textContent = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // Show floating text at element position
        function floatTextAt(text, element, type = '') {
            if (!element) return;
            const rect = element.getBoundingClientRect();
            floatText(text, rect.left + rect.width / 2 - 20, rect.top);
        }
        function playS(t) { if (!S.sound) return; try { const a = new (window.AudioContext || window.webkitAudioContext)(), o = a.createOscillator(), g = a.createGain(); o.connect(g); g.connect(a.destination); g.gain.value = 0.06; if (t === 'tap') { o.frequency.value = 800; o.start(); g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.06); o.stop(a.currentTime + 0.06) } else if (t === 'sell') { o.frequency.value = 600; o.start(); o.frequency.exponentialRampToValueAtTime(1100, a.currentTime + 0.1); g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.12); o.stop(a.currentTime + 0.12) } else if (t === 'ach') { o.frequency.value = 523; o.start(); setTimeout(() => o.frequency.value = 659, 100); setTimeout(() => o.frequency.value = 784, 200); g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.4); o.stop(a.currentTime + 0.4) } } catch (e) { } }
        function getInvTotal() { return Object.values(S.inv).reduce((a, b) => a + b, 0) }
        function hasItem(id, n) { return (S.inv[id] || 0) >= n }
        function addItem(id, n) { S.inv[id] = (S.inv[id] || 0) + n }
        function remItem(id, n) { const h = S.inv[id] || 0, r = Math.min(h, n); S.inv[id] = h - r; if (S.inv[id] <= 0) delete S.inv[id]; return r }
        function getPrice(id) { if (!S.prices[id]) S.prices[id] = R[id]?.p || 1; return S.prices[id] }
        function updatePrices() { for (const id in R) { if (!S.prices[id]) S.prices[id] = R[id].p; if (!S.priceDir[id]) S.priceDir[id] = Math.random() > 0.5 ? 1 : -1; if (Math.random() < 0.1) { S.priceDir[id] *= -1 } S.prices[id] = Math.max(1, Math.min(R[id].p * 2, S.prices[id] + S.priceDir[id] * Math.floor(Math.random() * 2))) } }
        function canAfford(c) { if (c.m && S.money < c.m) return 0; for (const k in c) if (k !== 'm' && !hasItem(k, c[k])) return 0; return 1 }
        function pay(c) { if (c.m) S.money -= c.m; for (const k in c) if (k !== 'm') remItem(k, c[k]) }

        function update(dt) {
            const sec = dt / 1000;
            let invTotal = getInvTotal();
            for (const p of S.plots) {
                for (const s of p.subs) {
                    const cfg = T[s.t]; if (!cfg) continue;
                    if (cfg.tap) continue;// Manufacturing needs tap
                    if (cfg.r) {
                        const rate = cfg.r * (1 + 0.2 * (s.lv - 1)) * (s.boost || 1) * getEventMultiplier('farm');
                        s.c = Math.min(cfg.m, s.c + rate * sec);
                        if (cfg.x) {
                            for (const xid in cfg.x) {
                                if (invTotal >= S.cap) break;
                                const expected = cfg.x[xid] * sec;
                                if (expected <= 0) continue;
                                let count = Math.floor(expected);
                                if (Math.random() < (expected - count)) count++;
                                if (count <= 0) continue;
                                count = Math.min(count, Math.max(0, S.cap - invTotal));
                                if (count <= 0) continue;
                                addItem(xid, count);
                                invTotal += count;
                            }
                        }
                    }
                }
            }
            // Workers
            for (const w of S.workers) {
                const interval = w.interval || 5;
                w.timer = (w.timer || 0) + sec;
                const ticks = Math.floor(w.timer / interval);
                if (ticks <= 0) continue;
                w.timer = w.timer - ticks * interval;

                const p = S.plots[w.plot]; if (!p) continue;
                const s = p.subs[w.sub]; if (!s) continue;
                const cfg = T[s.t]; if (!cfg) continue;

                let space = Math.max(0, S.cap - invTotal);
                if (space <= 0) continue;

                if (cfg.tap && cfg.req) {
                    const have = S.inv[cfg.req] || 0;
                    const possible = cfg.use > 0 ? Math.floor(have / cfg.use) : 0;
                    const make = Math.min(ticks, possible, space);
                    if (make <= 0) continue;

                    remItem(cfg.req, make * cfg.use);
                    addItem(cfg.o, make);
                    S.stats.harvested += make;
                    invTotal += make - make * cfg.use;
                    if (invTotal < 0) invTotal = 0;
                } else {
                    const available = Math.floor(s.c);
                    const take = Math.min(ticks, available, space);
                    if (take <= 0) continue;
                    s.c -= take;
                    addItem(cfg.o, take);
                    S.stats.harvested += take;
                    invTotal += take;
                }
            }
            updatePrices();
            checkAchievements();
            checkEvents();
        }

        // Event System
        function checkEvents() {
            const now = Date.now();

            // Check if active event has ended
            if (S.activeEvent && S.eventEndsAt && now >= S.eventEndsAt) {
                notif(`${S.activeEvent.n} has ended!`);
                S.activeEvent = null;
                S.eventEndsAt = 0;
            }

            // Check if it's time for a new event
            if (!S.activeEvent && S.nextEventAt && now >= S.nextEventAt) {
                triggerRandomEvent();
                // Schedule next event in 5-15 minutes
                S.nextEventAt = now + 300000 + Math.random() * 600000;
            }
        }

        function triggerRandomEvent() {
            const event = EVENTS[Math.floor(Math.random() * EVENTS.length)];

            if (event.duration > 0) {
                // Timed event
                S.activeEvent = event;
                S.eventEndsAt = Date.now() + event.duration;
                notif(`${event.n} ‚Äî ${event.d}`);
                playS('ach');
            } else {
                // Instant event
                applyInstantEvent(event);
            }
            save();
        }

        function applyInstantEvent(event) {
            if (event.effect === 'bonus') {
                S.money += event.amount;
                notif(`${event.n} ‚Äî +$${event.amount}!`);
                floatText(`+$${event.amount}`, window.innerWidth / 2 - 30, 100, 'sell');
            } else if (event.effect === 'fillAll') {
                for (const p of S.plots) {
                    for (const s of p.subs) {
                        const cfg = T[s.t];
                        if (cfg && cfg.m) s.c = cfg.m;
                    }
                }
                notif(`${event.n} ‚Äî ${event.d}`);
            }
            playS('ach');
        }

        function getEventMultiplier(type) {
            if (!S.activeEvent) return 1;
            if (type === 'farm' && S.activeEvent.effect === 'farmBoost') return S.activeEvent.mult;
            if (type === 'price' && S.activeEvent.effect === 'priceBoost') return S.activeEvent.mult;
            return 1;
        }

        function tap(pi, si) {
            const s = S.plots[pi]?.subs[si]; if (!s) return;
            const cfg = T[s.t]; if (!cfg) return;
            const el = document.querySelector(`[data-p="${pi}"][data-s="${si}"]`);
            if (getInvTotal() >= S.cap) {
                toast('Inventory full!', 'err');
                playS('err');
                if (el) { el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake'); }
                return;
            }
            if (cfg.tap) {
                if (!cfg.req) { toast('Nothing to produce', 'err'); return }
                if (!hasItem(cfg.req, cfg.use)) {
                    toast(`Need ${cfg.use} ${R[cfg.req]?.i || cfg.req}`, 'err');
                    playS('err');
                    if (el) { el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake'); }
                    return;
                }
                remItem(cfg.req, cfg.use); addItem(cfg.o, 1); S.stats.harvested++; playS('tap');
                floatTextAt(`+1 ${R[cfg.o]?.i}`, el);
            } else {
                if (s.c < 1) return;
                s.c--; addItem(cfg.o, 1); S.stats.harvested++; playS('tap');
                floatTextAt(`+1 ${R[cfg.o]?.i}`, el);
                const iconEl = el?.querySelector('.icon');
                if (iconEl) { iconEl.classList.remove('pop'); void iconEl.offsetWidth; iconEl.classList.add('pop'); }
            }
            save(); render();
        }

        function openBuild(pi, si) {
            buildP = pi; buildS = si;
            let h = '';
            const cur = S.plots[pi]?.subs[si];
            const curCfg = cur ? T[cur.t] : null;

            // If there's an existing building, show upgrade option first
            if (cur && curCfg?.b && cur.lv < 5) {
                const upgradeCost = getUpgradeCost(cur.t, cur.lv);
                const canUpgrade = canAfford(upgradeCost);
                const costStr = Object.entries(upgradeCost).map(([k, v]) => k === 'm' ? `<span class="m">$${v}</span>` : `<span class="r">${v}${R[k]?.i || k}</span>`).join(' ');
                const nextBonus = Math.round((1 + 0.2 * cur.lv) * 100);
                h += `<div class="cat"><div class="cat-title">‚¨ÜÔ∏è Upgrade Current Building</div>`;
                h += `<div class="bld ${canUpgrade ? '' : 'off'}" data-t="__upgrade" style="border:1px solid var(--purple)">`;
                h += `<div class="ic">${curCfg.i}</div>`;
                h += `<div class="info"><div class="nm" style="color:var(--purple)">${curCfg.n} Lv${cur.lv} ‚Üí Lv${cur.lv + 1}</div>`;
                h += `<div class="prod">Production: +${nextBonus}%</div>`;
                h += `<div class="cost">${costStr}</div></div></div></div>`;
            } else if (cur && curCfg?.b && cur.lv >= 5) {
                h += `<div class="cat"><div class="cat-title">‚¨ÜÔ∏è Upgrade</div>`;
                h += `<div class="bld off"><div class="ic">‚≠ê</div><div class="info"><div class="nm">${curCfg.n} MAX LEVEL</div><div class="prod">This building is fully upgraded!</div></div></div></div>`;
            }

            // Build new options (only show if no building or it's a wild plot)
            if (!curCfg?.b) {
                const cats = [{ k: 'farms', t: 'üåæ Farms' }, { k: 'livestock', t: 'üêÑ Livestock' }, { k: 'manufacturing', t: 'üè≠ Manufacturing' }, { k: 'utility', t: 'üì¶ Utility' }];
                for (const cat of cats) {
                    h += `<div class="cat"><div class="cat-title">${cat.t}</div>`;
                    for (const b of B[cat.k]) {
                        const cfg = T[b.t]; if (!cfg) continue;
                        const can = canAfford(b.c);
                        const cst = Object.entries(b.c).map(([k, v]) => k === 'm' ? `<span class="m">$${v}</span>` : `<span class="r">${v}${R[k]?.i || k}</span>`).join(' ');
                        h += `<div class="bld ${can ? '' : 'off'}" data-t="${b.t}"><div class="ic">${cfg.i}</div><div class="info"><div class="nm">${cfg.n}</div><div class="prod">${cfg.o ? `‚Üí ${R[cfg.o]?.i || ''} ${R[cfg.o]?.n || ''}` : (cfg.cap ? `+${cfg.cap} storage` : '')}</div><div class="cost">${cst}</div></div></div>`;
                    }
                    h += `</div>`;
                }
            }

            // Demolish option for buildings
            if (cur && curCfg?.b) {
                h += `<div class="cat"><div class="cat-title">‚ö†Ô∏è Demolish</div><div class="bld" data-t="__demolish" style="border:1px solid var(--red)"><div class="ic">üóëÔ∏è</div><div class="info"><div class="nm" style="color:var(--red)">Remove Building</div><div class="prod">Returns 50% resources</div></div></div></div>`;
            }
            $('build-list').innerHTML = h;
            $('build-list').querySelectorAll('.bld:not(.off)').forEach(el => el.onclick = () => doBuild(el.dataset.t));
            $('build-modal').classList.add('show'); playS('tap');
        }

        // Calculate upgrade cost based on building type and current level
        function getUpgradeCost(buildingType, currentLevel) {
            const base = Object.values(B).flat().find(b => b.t === buildingType);
            if (!base) return { m: 9999999 };
            const multiplier = currentLevel + 1;
            const cost = {};
            for (const k in base.c) {
                cost[k] = Math.floor(base.c[k] * multiplier * 0.75);
            }
            return cost;
        }

        function closeBuild() { $('build-modal').classList.remove('show') }

        function doBuild(t) {
            if (t === '__upgrade') {
                const s = S.plots[buildP]?.subs[buildS]; if (!s || s.lv >= 5) return;
                const cost = getUpgradeCost(s.t, s.lv);
                if (!canAfford(cost)) { toast('Cannot afford upgrade!', 'err'); return; }
                pay(cost);
                s.lv++;
                playS('ach');
                toast(`Upgraded to Lv${s.lv}!`, 'ok');
                notif(`‚¨ÜÔ∏è ${T[s.t]?.n} upgraded to Level ${s.lv}!`);
                closeBuild(); save(); render();
                return;
            }
            if (t === '__demolish') {
                const s = S.plots[buildP]?.subs[buildS]; if (!s) return;
                const orig = Object.values(B).flat().find(b => b.t === s.t);
                if (orig) { for (const k in orig.c) { if (k === 'm') S.money += Math.floor(orig.c.m * 0.5); else addItem(k, Math.floor(orig.c[k] * 0.5)) } }
                s.t = 'forest'; s.c = 0; s.lv = 1;
                toast('Building demolished', 'ok'); closeBuild(); save(); render(); return;
            }
            const b = Object.values(B).flat().find(x => x.t === t); if (!b || !canAfford(b.c)) return;
            pay(b.c);
            S.plots[buildP].subs[buildS] = { t, c: 0, lv: 1 };
            S.stats.built++;
            if (T[t]?.cap) S.cap += T[t].cap;
            playS('sell'); toast(`Built ${T[t]?.n}!`, 'ok'); notif(`üèóÔ∏è New building: ${T[t]?.n}`);
            closeBuild(); save(); render();
        }

        function buyPlot() {
            const cost = PLOTS[S.plots.length] || 999999;
            if (S.money < cost) { toast('Not enough!', 'err'); return }
            S.money -= cost;
            S.plots.push({ subs: [{ t: 'forest', c: 3, lv: 1 }, { t: 'berryBush', c: 2, lv: 1 }, { t: 'quarry', c: 1, lv: 1 }] });
            playS('sell'); toast('New plot!', 'ok'); save(); render();
        }

        function hireWorker(pi, si) {
            if (S.workers.length >= 10) { toast('Max 10 workers', 'err'); return }
            const cost = 500 + S.workers.length * 200;
            if (S.money < cost) { toast(`Need $${cost}`, 'err'); return }
            S.money -= cost;
            S.workers.push({ plot: pi, sub: si, interval: 5, timer: 0 });
            playS('sell'); toast('Worker hired!', 'ok'); notif('üë∑ New worker hired!'); save(); render();
        }
        function fireWorker(i) {
            S.workers.splice(i, 1);
            toast('Worker fired', 'ok'); save(); render();
        }

        function sell(id, n) {
            const removed = remItem(id, n); if (!removed) return;
            const price = getPrice(id);
            const earn = Math.floor(removed * price * getEventMultiplier('price'));
            S.money += earn; S.stats.sold += removed; S.stats.earned += earn;
            playS('sell');
            // Show floating gold text near the stats bar
            floatText(`+$${earn}`, window.innerWidth / 2 - 30, 60, 'sell');
            save(); render();
        }

        function checkAchievements() {
            for (const a of ACH) {
                if (S.ach[a.id]) continue;
                let done = 0;
                if (a.id === 'h100' || a.id === 'h1000') done = S.stats.harvested >= a.g;
                else if (a.id === 'm1000' || a.id === 'm10000') done = S.stats.earned >= a.g;
                else if (a.id === 'p2') done = S.plots.length >= a.g;
                else if (a.id === 'b1' || a.id === 'b5') done = S.stats.built >= a.g;
                else if (a.id === 'w1') done = S.workers.length >= a.g;
                if (done) {
                    S.ach[a.id] = 1; S.money += a.r;
                    playS('ach'); notif(`üèÜ ${a.n} (+$${a.r})`);
                }
            }
        }
        function showAchievements() {
            let h = '';
            for (const a of ACH) {
                const done = S.ach[a.id];
                h += `<div class="achieve ${done ? 'done' : ''}"><div class="ic">${done ? '‚úÖ' : 'üîí'}</div><div class="info"><div class="nm">${a.n}</div><div class="desc">${a.d}</div><div class="reward">Reward: $${a.r}</div></div></div>`;
            }
            $('achieve-list').innerHTML = h;
            $('achieve-modal').classList.add('show'); closeMenu();
        }
        function closeAchieve() { $('achieve-modal').classList.remove('show') }

        // Daily Rewards System
        function showDaily() {
            const cal = $('daily-calendar');
            const streakEl = $('daily-streak');
            const btn = $('claim-daily-btn');

            // Render 7-day calendar
            let h = '';
            for (let i = 0; i < 7; i++) {
                const day = i + 1;
                const reward = DAILY_REWARDS[i];
                const claimed = (S.dailyStreak || 0) >= day && !canClaimDaily();
                const current = ((S.dailyStreak || 0) % 7) + 1 === day && canClaimDaily();
                const dayClass = claimed ? 'claimed' : (current ? 'current' : '');
                h += `<div class="daily-day ${dayClass}" style="text-align:center;padding:8px 4px;background:var(--bg2);border-radius:6px;border:2px solid ${current ? 'var(--gold)' : 'transparent'}">
                    <div style="font-size:0.75rem;color:var(--muted)">Day ${day}</div>
                    <div style="font-size:1.2rem">${claimed ? '‚úÖ' : 'üí∞'}</div>
                    <div style="font-size:0.7rem;color:var(--gold)">${reward.desc}</div>
                </div>`;
            }
            cal.innerHTML = h;

            // Update streak display
            streakEl.innerHTML = `üî• Current Streak: <b>${S.dailyStreak || 0}</b> days`;

            // Update button
            if (canClaimDaily()) {
                const nextDay = ((S.dailyStreak || 0) % 7);
                const reward = DAILY_REWARDS[nextDay];
                btn.disabled = false;
                btn.textContent = `üéÅ Claim ${reward.desc}!`;
                btn.classList.remove('off');
            } else {
                btn.disabled = true;
                btn.textContent = '‚è∞ Come back tomorrow!';
                btn.classList.add('off');
            }

            $('daily-modal').classList.add('show'); closeMenu();
        }

        function closeDaily() { $('daily-modal').classList.remove('show') }

        function canClaimDaily() {
            if (!S.lastDailyReward) return true;
            const lastDate = new Date(S.lastDailyReward);
            const today = new Date();
            // Reset to start of day for comparison
            lastDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            return today.getTime() > lastDate.getTime();
        }

        function claimDaily() {
            if (!canClaimDaily()) return;

            const lastDate = S.lastDailyReward ? new Date(S.lastDailyReward) : null;
            const today = new Date();

            // Check if streak should reset (more than 1 day gap)
            if (lastDate) {
                lastDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > 1) {
                    S.dailyStreak = 0; // Reset streak
                }
            }

            // Get current day reward (cycling 0-6)
            const dayIndex = (S.dailyStreak || 0) % 7;
            const reward = DAILY_REWARDS[dayIndex];

            // Give reward
            S.money += reward.reward;
            S.dailyStreak = (S.dailyStreak || 0) + 1;
            S.lastDailyReward = Date.now();

            playS('ach');
            floatText(`+$${reward.reward}`, window.innerWidth / 2 - 30, 100, 'sell');
            notif(`üéÅ Day ${dayIndex + 1} reward: ${reward.desc}!`);
            toast(`Claimed ${reward.desc}!`, 'ok');

            save();
            closeDaily();
            render();
        }

        function checkDailyReward() {
            // Auto-show daily reward popup if available (after a short delay)
            if (canClaimDaily()) {
                setTimeout(() => {
                    notif('üéÅ Daily reward available!');
                }, 2000);
            }
        }

        function showMenu() { $('menu-modal').classList.add('show') }
        function closeMenu() { $('menu-modal').classList.remove('show') }

        // Leaderboard System
        async function showLeaderboard() {
            closeMenu();
            $('leaderboard-modal').classList.add('show');
            $('leaderboard-body').innerHTML = '<div class="empty">Loading leaderboard...</div>';

            if (!db) {
                $('leaderboard-body').innerHTML = '<div class="empty">‚ö†Ô∏è Connect to play online to view leaderboard</div>';
                return;
            }

            try {
                // Fetch top 20 players by money from cloud saves
                const snap = await db.collection('saves')
                    .orderBy('money', 'desc')
                    .limit(20)
                    .get();

                if (snap.empty) {
                    $('leaderboard-body').innerHTML = '<div class="empty">No players yet!</div>';
                    return;
                }

                let h = '';
                let rank = 1;
                snap.docs.forEach(doc => {
                    const data = doc.data();
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                    const isMe = loggedInUser && loggedInUser.id === doc.id;
                    h += `<div style="display:flex;align-items:center;padding:12px;background:var(--bg2);border-radius:8px;margin-bottom:6px;${isMe ? 'border:2px solid var(--gold)' : ''}">
                        <span style="width:40px;font-weight:700;font-size:1.2rem">${medal}</span>
                        <span style="flex:1;font-weight:${rank <= 3 ? '600' : '400'}">${data.username || 'Anonymous'}</span>
                        <span style="color:var(--gold);font-weight:700">$${(data.money || 0).toLocaleString()}</span>
                    </div>`;
                    rank++;
                });

                $('leaderboard-body').innerHTML = h;
            } catch (e) {
                console.error('Leaderboard error:', e);
                $('leaderboard-body').innerHTML = '<div class="empty">Failed to load leaderboard</div>';
            }
        }

        function closeLeaderboard() { $('leaderboard-modal').classList.remove('show') }

        function showTip(e, id) {
            clearTimeout(tipTimer);
            const r = R[id]; if (!r) return;
            const tip = $('tip');
            tip.innerHTML = `<h4>${r.i} ${r.n}</h4><p>Price: $${getPrice(id)}</p>`;
            const rect = e.target.getBoundingClientRect();
            tip.style.left = Math.min(rect.left, window.innerWidth - 210) + 'px';
            tip.style.top = (rect.bottom + 5) + 'px';
            tip.classList.add('show');
            tipTimer = setTimeout(() => tip.classList.remove('show'), 2000);
        }

        function closeTutorial() { $('tutorial').style.display = 'none'; S.tutorial = 1; save() }

        function render() {
            $('money').textContent = '$' + S.money.toLocaleString();
            $('inv').textContent = getInvTotal();
            const m = $('main');
            if (screen === 'home') renderHome(m);
            else if (screen === 'inventory') renderInventory(m);
            else if (screen === 'workers') renderWorkers(m);
            else if (screen === 'player') {
                // Don't re-render if user is typing in an input
                const focused = document.activeElement;
                if (!focused || (focused.tagName !== 'INPUT' && focused.tagName !== 'SELECT')) {
                    renderPlayerMarket(m);
                }
            }
            else if (screen === 'market') renderMarket(m);
            else if (screen === 'stats') renderStats(m);
            // Update nav button active states
            document.querySelectorAll('.nav button').forEach(b => {
                b.classList.toggle('active', b.dataset.s === screen || (b.id === 'nav-1' && (screen === 'home' || screen === 'inventory')));
            });
            // Update button 1 label
            $('nav-1-label').textContent = screen === 'inventory' ? 'Home' : 'Inventory';
        }

        function renderInventory(m) {
            let h = `<div class="panel"><h3>üì¶ Inventory</h3>`;
            const items = Object.entries(S.inv).filter(([_, q]) => q > 0);
            if (items.length === 0) {
                h += `<div class="empty">No items yet!</div>`;
            } else {
                h += `<div class="list">`;
                for (const [id, qty] of items) {
                    const r = R[id];
                    if (!r) continue;
                    h += `<div class="item"><span class="ic">${r.i}</span><span class="nm">${r.n}</span><span class="qt">√ó${qty}</span></div>`;
                }
                h += `</div>`;
            }
            h += `</div>`;
            m.innerHTML = h;
        }

        function renderHome(m) {
            let h = '';
            S.plots.forEach((p, pi) => {
                h += `<div class="plot"><div class="subs">`;
                p.subs.forEach((s, si) => {
                    const cfg = T[s.t]; if (!cfg) return;
                    const cnt = Math.floor(s.c);
                    const pct = cfg.m ? (s.c / cfg.m) * 100 : 0;
                    const ready = cnt > 0 || (cfg.tap && cfg.req && hasItem(cfg.req, cfg.use));
                    h += `<div class="sub ${ready ? 'ready' : ''} ${cfg.b ? 'building' : ''}" data-p="${pi}" data-s="${si}"><span class="cnt ${cnt === 0 ? 'zero' : ''}">${cnt}</span><div class="icon">${cfg.i}</div><div class="bar"><div style="width:${pct}%"></div></div>${s.lv > 1 ? `<span class="lvl">Lv${s.lv}</span>` : ''}</div>`;
                });
                h += `</div></div>`;
            });
            const nc = PLOTS[S.plots.length] || 999999;
            h += `<div class="plot locked ${S.money >= nc ? 'can' : ''}"><div style="font-size:1.8rem;opacity:0.5">üîí</div><h4>$${nc.toLocaleString()}</h4><button ${S.money >= nc ? '' : 'disabled'} onclick="buyPlot()">${S.money >= nc ? 'Buy Plot' : 'Need $' + (nc - S.money).toLocaleString()}</button></div>`;
            m.innerHTML = h;
            // Attach click handlers - use simple onclick with global hold state
            m.querySelectorAll('.sub').forEach(el => {
                el.onclick = (e) => {
                    e.preventDefault();
                    // Simple click = harvest
                    tap(+el.dataset.p, +el.dataset.s);
                };
            });
        }

        // Global hold detection - separate from render cycle
        let holdTarget = null;
        let holdTimer = null;
        let holdStart = 0;

        document.addEventListener('mousedown', (e) => {
            const sub = e.target.closest('.sub');
            if (!sub) return;
            holdTarget = sub;
            holdStart = Date.now();
            holdTimer = setTimeout(() => {
                if (holdTarget === sub) {
                    openBuild(+sub.dataset.p, +sub.dataset.s);
                    holdTarget = null;
                }
            }, 3000); // 3 seconds
        });

        document.addEventListener('mouseup', () => {
            clearTimeout(holdTimer);
            holdTarget = null;
        });

        document.addEventListener('touchstart', (e) => {
            const sub = e.target.closest('.sub');
            if (!sub) return;
            holdTarget = sub;
            holdStart = Date.now();
            holdTimer = setTimeout(() => {
                if (holdTarget === sub) {
                    openBuild(+sub.dataset.p, +sub.dataset.s);
                    holdTarget = null;
                }
            }, 3000);
        }, { passive: true });

        document.addEventListener('touchend', () => {
            clearTimeout(holdTimer);
            holdTarget = null;
        });

        function renderWorkers(m) {
            let h = `<div class="panel"><h3>üë∑ Workers (${S.workers.length}/10)</h3><p style="color:var(--muted);font-size:0.8rem;margin-bottom:12px">Workers auto-harvest every 5 seconds. Tap a plot on Home screen, then "Hire Worker" below.</p>`;
            if (S.workers.length === 0) h += `<div class="empty">No workers yet</div>`;
            else {
                h += `<div class="list">`;
                S.workers.forEach((w, i) => {
                    const s = S.plots[w.plot]?.subs[w.sub];
                    const cfg = s ? T[s.t] : null;
                    h += `<div class="npc"><div class="ic">üë∑</div><div class="info"><div class="nm">Worker #${i + 1}</div><div class="rate">On: ${cfg?.n || '?'} (Plot ${w.plot + 1})</div></div><button class="btn red" onclick="fireWorker(${i})">Fire</button></div>`;
                });
                h += `</div>`;
            }
            h += `</div><div class="panel"><h3>‚ûï Hire for Plot</h3><div class="list">`;
            S.plots.forEach((p, pi) => {
                p.subs.forEach((s, si) => {
                    const cfg = T[s.t]; if (!cfg) return;
                    const cost = 500 + S.workers.length * 200;
                    h += `<div class="item"><span class="ic">${cfg.i}</span><span class="nm">Plot ${pi + 1} - ${cfg.n}</span><button class="btn green" onclick="hireWorker(${pi},${si})">$${cost}</button></div>`;
                });
            });
            h += `</div></div>`;
            m.innerHTML = h;
        }

        function renderMarket(m) {
            let h = `<div class="panel"><h3>üèõÔ∏è Government Market</h3><p style="color:var(--muted);font-size:0.75rem;margin-bottom:10px">Prices change over time!</p><div class="list">`;
            for (const id in S.inv) {
                const r = R[id]; if (!r || S.inv[id] <= 0) continue;
                const price = getPrice(id);
                h += `<div class="item" onmouseenter="showTip(event,'${id}')"><span class="ic">${r.i}</span><span class="nm">${r.n}</span><span class="pr">$${price}</span><span class="qt">√ó${S.inv[id]}</span><button class="btn" onclick="sell('${id}',${S.inv[id]})">Sell</button></div>`;
            }
            if (Object.keys(S.inv).length === 0) h += `<div class="empty">Nothing to sell</div>`;
            h += `</div></div>`;
            h += `<div class="panel"><h3>üìä Price List</h3><div class="list">`;
            for (const id in R) {
                const r = R[id];
                const price = getPrice(id);
                const base = r.p;
                const diff = price - base;
                h += `<div class="item"><span class="ic">${r.i}</span><span class="nm">${r.n}</span><span class="pr" style="color:${diff > 0 ? 'var(--green)' : diff < 0 ? 'var(--red)' : 'var(--muted)'}">$${price} ${diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : ''}</span></div>`;
            }
            h += `</div></div>`;
            m.innerHTML = h;
        }

        function renderStats(m) {
            let h = `<div class="panel"><h3>üìà Statistics</h3><div class="list">`;
            h += `<div class="item"><span class="ic">üåæ</span><span class="nm">Total Harvested</span><span class="qt">${S.stats.harvested}</span></div>`;
            h += `<div class="item"><span class="ic">üí∞</span><span class="nm">Total Earned</span><span class="qt">$${S.stats.earned.toLocaleString()}</span></div>`;
            h += `<div class="item"><span class="ic">üì¶</span><span class="nm">Items Sold</span><span class="qt">${S.stats.sold}</span></div>`;
            h += `<div class="item"><span class="ic">üèóÔ∏è</span><span class="nm">Buildings Built</span><span class="qt">${S.stats.built}</span></div>`;
            h += `<div class="item"><span class="ic">üë∑</span><span class="nm">Workers</span><span class="qt">${S.workers.length}</span></div>`;
            h += `<div class="item"><span class="ic">üèûÔ∏è</span><span class="nm">Plots Owned</span><span class="qt">${S.plots.length}</span></div>`;
            h += `</div></div>`;
            m.innerHTML = h;
        }

        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyBu_Ge0jpMTxSz8-n-12VwsjMFj6gCJBwQ",
            authDomain: "tappy-trade.firebaseapp.com",
            projectId: "tappy-trade",
            storageBucket: "tappy-trade.firebasestorage.app",
            messagingSenderId: "408809771678",
            appId: "1:408809771678:web:205415f89cac488604618f"
        };

        let db = null, auth = null, userId = null, unsubOrders = null;
        let orders = [];

        async function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();

                // Anonymous sign in
                const result = await auth.signInAnonymously();
                userId = result.user.uid;
                console.log('Firebase connected, user:', userId);
                notif('üåê Connected to market!');

                // Listen for orders
                unsubOrders = db.collection('orders')
                    .where('status', '==', 'open')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .onSnapshot(snap => {
                        orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (screen === 'player') render();
                    });

                // Load cloud save if logged in
                if (loggedInUser) {
                    const loaded = await loadFromCloud();
                    if (loaded) {
                        notif('‚òÅÔ∏è Cloud progress loaded!');
                        render();
                    }
                }
            } catch (e) {
                console.error('Firebase error:', e);
                toast('Market offline', 'err');
            }
        }

        async function postOrder(type, resource, qty, price) {
            if (!db || !userId) { toast('Not connected!', 'err'); return; }
            if (type === 'sell' && !hasItem(resource, qty)) { toast('Not enough items!', 'err'); return; }
            if (type === 'buy' && S.money < qty * price) { toast('Not enough money!', 'err'); return; }

            // Reserve items/money
            if (type === 'sell') remItem(resource, qty);
            if (type === 'buy') S.money -= qty * price;

            try {
                await db.collection('orders').add({
                    type, resource, qty, price,
                    userId, status: 'open',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                playS('sell');
                toast(`Order posted!`, 'ok');
                save();
            } catch (e) {
                // Refund on error
                if (type === 'sell') addItem(resource, qty);
                if (type === 'buy') S.money += qty * price;
                toast('Failed to post', 'err');
            }
        }

        async function fillOrder(order) {
            if (!db || !userId) return;
            if (order.userId === userId) { toast("Can't fill own order", 'err'); return; }

            const total = order.qty * order.price;

            if (order.type === 'sell') {
                // Buyer pays money, gets items
                if (S.money < total) { toast('Not enough $!', 'err'); return; }
                S.money -= total;
                addItem(order.resource, order.qty);
            } else {
                // Seller gives items, gets money
                if (!hasItem(order.resource, order.qty)) { toast('Not enough items!', 'err'); return; }
                remItem(order.resource, order.qty);
                S.money += total;
            }

            try {
                await db.collection('orders').doc(order.id).update({
                    status: 'filled', filledBy: userId,
                    filledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                playS('sell');
                toast(`Trade complete! ${order.type === 'sell' ? '+' + order.qty + ' ' + R[order.resource]?.i : '+$' + total}`, 'ok');
                save();
            } catch (e) {
                // Refund
                if (order.type === 'sell') { S.money += total; remItem(order.resource, order.qty); }
                else { addItem(order.resource, order.qty); S.money -= total; }
                toast('Trade failed', 'err');
            }
        }

        async function cancelOrder(order) {
            if (!db || order.userId !== userId) return;
            try {
                await db.collection('orders').doc(order.id).delete();
                // Refund
                if (order.type === 'sell') addItem(order.resource, order.qty);
                if (order.type === 'buy') S.money += order.qty * order.price;
                toast('Order cancelled', 'ok');
                save();
            } catch (e) { toast('Cancel failed', 'err'); }
        }

        let postRes = 'wood', postQty = 10, postPrice = 5, postType = 'sell';

        function renderPlayerMarket(m) {
            const connected = !!userId;
            let h = `<div class="panel"><h3>üè™ Player Market ${connected ? '<span style="color:var(--green)">‚óè</span>' : '<span style="color:var(--red)">‚óã</span>'}</h3>`;

            if (!connected) {
                h += `<div class="empty">Connecting to market...</div></div>`;
                m.innerHTML = h;
                return;
            }

            // Post order form
            h += `<div style="margin-bottom:16px;padding:12px;background:var(--bg2);border-radius:8px">
                <div style="display:flex;gap:8px;margin-bottom:8px">
                    <button class="btn ${postType === 'sell' ? 'green' : ''}" id="type-sell" style="flex:1">Sell</button>
                    <button class="btn ${postType === 'buy' ? 'purple' : ''}" id="type-buy" style="flex:1">Buy</button>
                </div>
                <div style="display:flex;gap:8px;margin-bottom:8px">
                    <select id="post-res" style="flex:2;padding:8px;border-radius:6px;background:var(--card);color:var(--text);border:none">
                        ${Object.entries(R).map(([k, v]) => `<option value="${k}" ${k === postRes ? 'selected' : ''}>${v.i} ${v.n}</option>`).join('')}
                    </select>
                    <input type="number" id="post-qty" value="${postQty}" min="1" style="flex:1;padding:8px;border-radius:6px;background:var(--card);color:var(--text);border:none">
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <span>$</span>
                    <input type="number" id="post-price" value="${postPrice}" min="1" style="flex:1;padding:8px;border-radius:6px;background:var(--card);color:var(--text);border:none">
                    <span>each</span>
                    <button class="btn green" id="post-order">Post</button>
                </div>
                <div style="margin-top:8px;font-size:0.75rem;color:var(--muted)">
                    Total: $${postQty * postPrice} ${postType === 'sell' ? `(You have: ${S.inv[postRes] || 0})` : ''}
                </div>
            </div>`;

            // Orders
            const sellOrders = orders.filter(o => o.type === 'sell');
            const buyOrders = orders.filter(o => o.type === 'buy');

            h += `<h4 style="margin:12px 0 8px;font-size:0.9rem">üì§ Selling (${sellOrders.length})</h4>`;
            if (sellOrders.length === 0) h += `<div class="empty" style="padding:10px">No sell orders</div>`;
            else {
                h += `<div class="list">`;
                for (const o of sellOrders.slice(0, 10)) {
                    const r = R[o.resource];
                    const mine = o.userId === userId;
                    h += `<div class="item"><span class="ic">${r?.i || '?'}</span><span class="nm">${o.qty}√ó ${r?.n || o.resource}</span><span class="pr">$${o.price}/ea</span>`;
                    if (mine) h += `<button class="btn red" data-cancel="${o.id}">Cancel</button>`;
                    else h += `<button class="btn green" data-fill="${o.id}">Buy $${o.qty * o.price}</button>`;
                    h += `</div>`;
                }
                h += `</div>`;
            }

            h += `<h4 style="margin:12px 0 8px;font-size:0.9rem">üì• Buying (${buyOrders.length})</h4>`;
            if (buyOrders.length === 0) h += `<div class="empty" style="padding:10px">No buy orders</div>`;
            else {
                h += `<div class="list">`;
                for (const o of buyOrders.slice(0, 10)) {
                    const r = R[o.resource];
                    const mine = o.userId === userId;
                    h += `<div class="item"><span class="ic">${r?.i || '?'}</span><span class="nm">${o.qty}√ó ${r?.n || o.resource}</span><span class="pr">$${o.price}/ea</span>`;
                    if (mine) h += `<button class="btn red" data-cancel="${o.id}">Cancel</button>`;
                    else h += `<button class="btn purple" data-fill="${o.id}">Sell +$${o.qty * o.price}</button>`;
                    h += `</div>`;
                }
                h += `</div>`;
            }

            h += `</div>`;
            m.innerHTML = h;

            // Event listeners
            $('type-sell')?.addEventListener('click', () => { postType = 'sell'; render(); });
            $('type-buy')?.addEventListener('click', () => { postType = 'buy'; render(); });
            $('post-res')?.addEventListener('change', e => { postRes = e.target.value; postPrice = R[postRes]?.p || 5; render(); });
            $('post-qty')?.addEventListener('change', e => { postQty = Math.max(1, parseInt(e.target.value) || 1); render(); });
            $('post-price')?.addEventListener('change', e => { postPrice = Math.max(1, parseInt(e.target.value) || 1); render(); });
            $('post-order')?.addEventListener('click', () => postOrder(postType, postRes, postQty, postPrice));

            m.querySelectorAll('[data-fill]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const order = orders.find(o => o.id === btn.dataset.fill);
                    if (order) fillOrder(order);
                });
            });
            m.querySelectorAll('[data-cancel]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const order = orders.find(o => o.id === btn.dataset.cancel);
                    if (order) cancelOrder(order);
                });
            });
        }

        // ===== ACCOUNT SYSTEM (Firestore-based) =====
        let userName = 'Guest';
        let loggedInUser = null; // { username, id }
        let unsubChat = null;
        let chatMessages = [];

        function updateAccountUI() {
            const status = $('account-status');
            const loginForm = $('login-form');
            const loggedIn = $('logged-in');

            if (loggedInUser) {
                userName = loggedInUser.username;
                status.innerHTML = `‚úÖ <b>${userName}</b> - ‚òÅÔ∏è Cloud Save ON<br><small style="color:var(--muted)">Auto-saves every 30s</small>`;
                loginForm.style.display = 'none';
                loggedIn.style.display = 'block';
                $('display-name').textContent = userName;
            } else {
                userName = 'Guest';
                status.innerHTML = '‚ö†Ô∏è Not logged in (playing as guest)';
                loginForm.style.display = 'block';
                loggedIn.style.display = 'none';
            }
        }

        // Simple hash function for password (not cryptographically secure, but good enough for a game)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        async function registerAccount() {
            const name = $('auth-name').value.trim();
            const pass = $('auth-pass').value;

            if (!name) { toast('Enter a username', 'err'); return; }
            if (name.length < 3) { toast('Username must be 3+ characters', 'err'); return; }
            if (!pass || pass.length < 4) { toast('Password must be 4+ characters', 'err'); return; }
            if (!db) { toast('Not connected to server', 'err'); return; }

            try {
                // Check if username exists
                const existing = await db.collection('users').where('username', '==', name.toLowerCase()).get();
                if (!existing.empty) {
                    toast('Username already taken!', 'err');
                    return;
                }

                // Create account
                const doc = await db.collection('users').add({
                    username: name.toLowerCase(),
                    displayName: name,
                    passHash: simpleHash(pass),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                loggedInUser = { id: doc.id, username: name };
                localStorage.setItem('tt4_user', JSON.stringify(loggedInUser));

                // Save initial state to cloud
                await saveToCloud();

                toast('Account created!', 'ok');
                notif(`üë§ Welcome, ${name}!`);
                updateAccountUI();
                closeAccount();
            } catch (e) {
                toast('Failed to create account', 'err');
                console.error(e);
            }
        }

        async function loginAccount() {
            const name = $('auth-name').value.trim();
            const pass = $('auth-pass').value;

            if (!name || !pass) { toast('Enter username and password', 'err'); return; }
            if (!db) { toast('Not connected to server', 'err'); return; }

            try {
                const snap = await db.collection('users')
                    .where('username', '==', name.toLowerCase())
                    .where('passHash', '==', simpleHash(pass))
                    .get();

                if (snap.empty) {
                    toast('Wrong username or password', 'err');
                    return;
                }

                const user = snap.docs[0];
                loggedInUser = { id: user.id, username: user.data().displayName };
                localStorage.setItem('tt4_user', JSON.stringify(loggedInUser));

                toast('Logged in!', 'ok');

                // Load cloud save if exists
                const loaded = await loadFromCloud();
                if (loaded) {
                    toast('‚òÅÔ∏è Progress loaded!', 'ok');
                } else {
                    // First time on this device, save current progress to cloud
                    await saveToCloud();
                }

                updateAccountUI();
                closeAccount();
                render();
            } catch (e) {
                toast('Login failed', 'err');
                console.error(e);
            }
        }

        function logoutAccount() {
            loggedInUser = null;
            localStorage.removeItem('tt4_user');
            toast('Logged out', 'ok');
            updateAccountUI();
            closeAccount();
        }

        // Load saved user on start
        function loadSavedUser() {
            try {
                const saved = localStorage.getItem('tt4_user');
                if (saved) {
                    loggedInUser = JSON.parse(saved);
                    userName = loggedInUser.username;
                }
            } catch (e) { }
        }

        function showAccount() { closeMenu(); $('account-modal').classList.add('show'); updateAccountUI(); }
        function closeAccount() { $('account-modal').classList.remove('show'); }

        // ===== CHAT SYSTEM =====
        function showChat() {
            closeMenu();
            $('chat-modal').classList.add('show');
            loadChat();
        }
        function closeChat() {
            $('chat-modal').classList.remove('show');
            if (unsubChat) { unsubChat(); unsubChat = null; }
        }

        function loadChat() {
            if (!db) { $('chat-messages').innerHTML = '<div class="empty">Chat offline</div>'; return; }

            if (unsubChat) unsubChat();

            unsubChat = db.collection('chat')
                .orderBy('createdAt', 'desc')
                .limit(50)
                .onSnapshot(snap => {
                    chatMessages = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
                    renderChat();
                });
        }

        function renderChat() {
            const el = $('chat-messages');
            if (chatMessages.length === 0) {
                el.innerHTML = '<div class="empty">No messages yet. Be the first!</div>';
                return;
            }

            el.innerHTML = chatMessages.map(msg => {
                const time = msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                return `<div style="margin-bottom:8px;padding:8px;background:var(--bg2);border-radius:6px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <b style="color:var(--purple)">${msg.userName || 'Guest'}</b>
                        <span style="font-size:0.7rem;color:var(--muted)">${time}</span>
                    </div>
                    <div style="font-size:0.9rem">${msg.text}</div>
                </div>`;
            }).join('');

            el.scrollTop = el.scrollHeight;
        }

        async function sendChat() {
            const input = $('chat-input');
            const text = input.value.trim();
            if (!text || !db) return;

            if (!loggedInUser) {
                toast('Log in to chat!', 'err');
                return;
            }

            try {
                await db.collection('chat').add({
                    text,
                    userName: loggedInUser.username,
                    userId: loggedInUser.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = '';
            } catch (e) {
                toast('Failed to send', 'err');
            }
        }

        // Handle Enter key in chat
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && document.activeElement?.id === 'chat-input') {
                sendChat();
            }
        });

        // ===== RESET GAME =====
        function resetGame() {
            if (confirm('Are you sure you want to reset ALL your progress? This cannot be undone!')) {
                localStorage.removeItem('tt4');
                location.reload();
            }
        }

        function init() {
            loadSavedUser(); // Restore logged-in account
            if (load()) {
                const off = Date.now() - S.lastUpdate;
                if (off > 1000) {
                    const beforeHarvested = S.stats?.harvested || 0;
                    const beforeInv = getInvTotal();
                    update(Math.min(off, 8 * 3600000));
                    const harvested = (S.stats?.harvested || 0) - beforeHarvested;
                    const gained = getInvTotal() - beforeInv;
                    const hours = Math.floor(off / 3600000);
                    const mins = Math.floor((off % 3600000) / 60000);
                    if (hours > 0 || mins > 5) {
                        if (harvested > 0 || gained > 0) {
                            notif(`‚è∞ Offline for ${hours}h ${mins}m ‚Äî workers gathered +${Math.max(0, gained)} items`);
                        }
                    }
                }
                toast('Welcome back!');
            } else {
                $('tutorial').style.display = 'flex';
            }

            // Nav button handlers
            document.querySelectorAll('.nav button').forEach(b => {
                b.onclick = () => {
                    // Button 1 toggles between home and inventory
                    if (b.id === 'nav-1') {
                        screen = screen === 'inventory' ? 'home' : 'inventory';
                    } else {
                        screen = b.dataset.s;
                    }
                    render();
                };
            });

            $('menu-btn').onclick = showMenu;
            $('sound-btn').onclick = () => {
                S.sound = S.sound ? 0 : 1;
                $('sound-btn').textContent = S.sound ? 'üîä Sound ON' : 'üîá Sound OFF';
                // Also control music
                if (bgMusic) {
                    bgMusic.muted = !S.sound;
                }
                // If turning sound on, attempt to start music (requires gesture; this click counts)
                if (S.sound && window.__ttStartMusic) {
                    window.__ttStartMusic();
                }
                save();
            };
            $('sound-btn').textContent = S.sound ? 'üîä Sound ON' : 'üîá Sound OFF';
            render();
            initFirebase();
            setInterval(() => { update(1000); save(); render() }, 1000);

            // Check for daily reward
            checkDailyReward();

            // Day/night cycle updates
            updateDayNight();
            setInterval(updateDayNight, 60000); // Update every minute

            // Background music
            initMusic();
        }

        // Day/Night Cycle
        function updateDayNight() {
            const hour = new Date().getHours();
            const root = document.documentElement;

            if (hour >= 6 && hour < 12) {
                // Morning (6am-12pm)
                root.style.setProperty('--bg', '#1a1a2e');
                root.style.setProperty('--bg2', '#16213e');
                document.body.style.background = 'linear-gradient(180deg, #1a1a2e 0%, #16213e 100%)';
            } else if (hour >= 12 && hour < 18) {
                // Afternoon (12pm-6pm)
                root.style.setProperty('--bg', '#1e1e3f');
                root.style.setProperty('--bg2', '#252552');
                document.body.style.background = 'linear-gradient(180deg, #1e1e3f 0%, #252552 100%)';
            } else if (hour >= 18 && hour < 21) {
                // Evening (6pm-9pm) - sunset colors
                root.style.setProperty('--bg', '#1a1025');
                root.style.setProperty('--bg2', '#251a35');
                document.body.style.background = 'linear-gradient(180deg, #1a1025 0%, #251a35 100%)';
            } else {
                // Night (9pm-6am)
                root.style.setProperty('--bg', '#0d0d1a');
                root.style.setProperty('--bg2', '#12121f');
                document.body.style.background = 'linear-gradient(180deg, #0d0d1a 0%, #12121f 100%)';
            }
        }

        // Background music
        let bgMusic = null;
        let musicStarted = false;
        function initMusic() {
            // Try common paths so it works in both hosted and local file scenarios
            const MUSIC_CANDIDATES = [
                'music/Little Jam.mp3',
                './music/Little Jam.mp3',
                '/music/Little Jam.mp3',
                'public/music/Little Jam.mp3',
                './public/music/Little Jam.mp3',
            ];

            let musicIdx = 0;
            bgMusic = new Audio(MUSIC_CANDIDATES[musicIdx]);
            bgMusic.loop = true;
            bgMusic.volume = 0.3;
            bgMusic.muted = !S.sound;
            bgMusic.preload = 'auto';

            const tryNextSource = () => {
                musicIdx++;
                if (musicIdx >= MUSIC_CANDIDATES.length) {
                    console.log('Music file not found in any location');
                    return;
                }
                bgMusic.src = MUSIC_CANDIDATES[musicIdx];
                bgMusic.load();
            };

            bgMusic.addEventListener('error', () => {
                tryNextSource();
            });

            const tryPlay = async () => {
                if (musicStarted) return true;
                if (!S.sound) return false;
                bgMusic.muted = false;
                try {
                    await bgMusic.play();
                    musicStarted = true;
                    return true;
                } catch (e) {
                    console.log('Music autoplay blocked:', e.name);
                    return false;
                }
            };

            // Start on first user interaction - iOS requires touchend, not touchstart
            const startMusic = () => {
                if (musicStarted) {
                    removeListeners();
                    return;
                }
                tryPlay().then((started) => {
                    if (started) {
                        removeListeners();
                    }
                });
            };

            const removeListeners = () => {
                document.removeEventListener('click', startMusic);
                document.removeEventListener('touchstart', startMusic);
                document.removeEventListener('touchend', startMusic);
                document.removeEventListener('keydown', startMusic);
            };

            // Allow other UI (like sound toggle) to trigger play
            window.__ttStartMusic = startMusic;

            // Multiple event types for better mobile compatibility
            document.addEventListener('click', startMusic);
            document.addEventListener('touchstart', startMusic, { passive: true });
            document.addEventListener('touchend', startMusic, { passive: true });
            document.addEventListener('keydown', startMusic);
        }
        init();
    </script>
</body>

</html>